<!DOCTYPE html>
<html lang="zh-TW">
Â  <head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  Â  <title>é«˜é›„ YouBike ç«™é»æœå°‹</title>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
Â  Â  <link rel="manifest" href="/YouBike/manifest.json" />
Â  Â  <script>
Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', function () {
Â  Â  Â  Â  Â  navigator.serviceWorker
Â  Â  Â  Â  Â  Â  .register("../YouBike/service-worker.js")
Â  Â  Â  Â  Â  Â  .then(function (registration) {
Â  Â  Â  Â  Â  Â  Â  console.log('Service Worker registered with scope:', registration.scope);
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(function (error) {
Â  Â  Â  Â  Â  Â  Â  console.error('Service Worker registration failed:', error);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  body {
Â  Â  Â  Â  font-family: 'Noto Sans TC', Arial, sans-serif;
Â  Â  Â  Â  margin: 20px;
Â  Â  Â  Â  background: #f4f4f4;
Â  Â  Â  Â  transition: background 0.5s ease, color 0.5s ease;
Â  Â  Â  }
Â  Â  Â  h1 {
Â  Â  Â  Â  color: #007BFF;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  }
Â  Â  Â  #searchContainer {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  margin-right: auto;
Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  position: relative;
Â  Â  Â  }
Â  Â  Â  #keyword {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding-right: 10px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 5px 0 0 5px;
Â  Â  Â  Â  margin-right: 0;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  overflow-wrap: break-word;
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  Â  #keyword:focus {
Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  border-color: #007BFF;
Â  Â  Â  Â  box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
Â  Â  Â  }
Â  Â  Â  #searchIcon {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  transform: translateY(-65%);
Â  Â  Â  }
Â  Â  Â  #searchIcon:hover {
Â  Â  Â  Â  color: #0056b3;
Â  Â  Â  }
Â  Â  Â  button {
Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  background-color: #007BFF;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 0 5px 5px 0;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  margin-left: 0;
Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  min-width: 50px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  Â  button:hover {
Â  Â  Â  Â  background-color: #0056b3;
Â  Â  Â  }
Â  Â  Â  #results {
Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  }
Â  Â  Â  .station {
Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  width: calc(33% - 20px);
Â  Â  Â  Â  min-width: 250px;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  transition: transform 0.2s ease, box-shadow 0.2s ease;
Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  overflow-wrap: break-word;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  position: relative;
Â  Â  Â  }
Â  Â  Â  .station:hover {
Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
Â  Â  Â  }
Â  Â  Â  .station h3 {
Â  Â  Â  Â  margin: 0 0 10px 0;
Â  Â  Â  Â  color: #007BFF;
Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  overflow-wrap: break-word;
Â  Â  Â  Â  padding-right: 30px;
Â  Â  Â  }
Â  Â  Â  .station p {
Â  Â  Â  Â  margin: 0 0 5px 0;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  overflow-wrap: break-word;
Â  Â  Â  }
Â  Â  Â  .station .pin-button {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  background: none;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  color: #007BFF;
Â  Â  Â  Â  transition: transform 0.2s ease, color 0.2s ease;
Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  height: auto;
Â  Â  Â  Â  border-radius: 0;
Â  Â  Â  Â  display: inline;
Â  Â  Â  }
Â  Â  Â  .station .pin-button:hover {
Â  Â  Â  Â  transform: scale(1.2);
Â  Â  Â  Â  color: #0056b3;
Â  Â  Â  }
Â  Â  Â  .station .pin-button.pinned {
Â  Â  Â  Â  color: #FFD700;
Â  Â  Â  }
Â  Â  Â  #loading {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  background: rgba(255, 255, 255, 0.8);
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  display: none;
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transition: opacity 0.5s ease;
Â  Â  Â  }
Â  Â  Â  #loading.show {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  Â  .overlay {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  z-index: 999;
Â  Â  Â  Â  display: none;
Â  Â  Â  }
Â  Â  Â  .overlay.show {
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  Â  .modal {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  display: none;
Â  Â  Â  }
Â  Â  Â  .modal.show {
Â  Â  Â  Â  display: block;
Â  Â  Â  }
Â  Â  Â  .modal button {
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  background-color: #007BFF;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  Â  transition: background-color 0.3s ease;
Â  Â  Â  }
Â  Â  Â  .modal button:hover {
Â  Â  Â  Â  background-color: #0056b3;
Â  Â  Â  }
Â  Â  Â  body.dark-mode {
Â  Â  Â  Â  background: #333;
Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  Â  transition: background 0.5s ease, color 0.5s ease;
Â  Â  Â  }
Â  Â  Â  body.dark-mode h1 {
Â  Â  Â  Â  color: #90CAF9;
Â  Â  Â  }
Â  Â  Â  body.dark-mode #keyword {
Â  Â  Â  Â  background-color: #1e1e1e;
Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  Â  border-color: #90caf9;
Â  Â  Â  }
Â  Â  Â  body.dark-mode #keyword:focus {
Â  Â  Â  Â  box-shadow: 0 0 5px rgba(144, 202, 249, 0.5);
Â  Â  Â  }
Â  Â  Â  body.dark-mode button {
Â  Â  Â  Â  background-color: #90caf9;
Â  Â  Â  Â  color: #121212;
Â  Â  Â  }
Â  Â  Â  body.dark-mode button:hover {
Â  Â  Â  Â  background-color: #64b5f6;
Â  Â  Â  }
Â  Â  Â  body.dark-mode .station {
Â  Â  Â  Â  background-color: #444;
Â  Â  Â  Â  border-color: #555;
Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  }
Â  Â  Â  body.dark-mode .station h3 {
Â  Â  Â  Â  color: #90CAF9;
Â  Â  Â  }
Â  Â  Â  body.dark-mode .station p {
Â  Â  Â  Â  color: #cccccc;
Â  Â  Â  }
Â  Â  Â  body.dark-mode .modal {
Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  }
Â  Â  Â  body.dark-mode .overlay {
Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.8);
Â  Â  Â  }
Â  Â  Â  body.dark-mode #loading {
Â  Â  Â  Â  background: #ffffff;
Â  Â  Â  Â  color: #000000;
Â  Â  Â  }
Â  Â  Â  body.dark-mode #loadingOverlay {
Â  Â  Â  Â  background-color: rgba(51, 51, 51, 0.9);
Â  Â  Â  }
Â  Â  Â  body.dark-mode #loadingText {
Â  Â  Â  Â  color: #ffffff;
Â  Â  Â  }
Â  Â  Â  .switch {
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  width: 50px;
Â  Â  Â  Â  height: 24px;
Â  Â  Â  }
Â  Â  Â  .switch input {
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  height: 0;
Â  Â  Â  }
Â  Â  Â  .slider {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  background-color: #ccc;
Â  Â  Â  Â  transition: .4s;
Â  Â  Â  Â  border-radius: 24px;
Â  Â  Â  }
Â  Â  Â  .slider:before {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  content: "";
Â  Â  Â  Â  height: 18px;
Â  Â  Â  Â  width: 18px;
Â  Â  Â  Â  left: 3px;
Â  Â  Â  Â  bottom: 3px;
Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  transition: .4s;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  }
Â  Â  Â  input:checked + .slider {
Â  Â  Â  Â  background-color: #007BFF;
Â  Â  Â  }
Â  Â  Â  input:checked + .slider:before {
Â  Â  Â  Â  transform: translateX(26px);
Â  Â  Â  }
Â  Â  Â  #githubButton img {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  width: 45px;
Â  Â  Â  Â  height: 45px;
Â  Â  Â  Â  object-fit: contain;
Â  Â  Â  }
Â  Â  Â  #installButton {
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  bottom: 140px;
Â  Â  Â  Â  right: 20px;
Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  width: 50px;
Â  Â  Â  Â  height: 50px;
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  color: black;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  padding: 0;
Â  Â  Â  }
Â  Â  Â  #installButton img {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  margin: 0 auto;Â 
Â  Â  Â  Â  width: 45px;
Â  Â  Â  Â  height: 45px;
Â  Â  Â  Â  object-fit: contain;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  </style>
Â  </head>
Â  <body>
Â  Â  <div id="loadingOverlay">
Â  Â  Â  <div id="loadingContent">
Â  Â  Â  Â  <p id="loadingText">è¼‰å…¥ä¸­</p>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="mainContent" style="display:none;">
Â  Â  Â  <h1>é«˜é›„ YouBike æœå°‹</h1>
Â  Â  Â  <div id="searchContainer">
Â  Â  Â  Â  <input type="text" id="keyword" placeholder="è«‹è¼¸å…¥ç«™é»åç¨±ã€åœ°å€" value="" />
Â  Â  Â  Â  <span id="searchIcon" title="æœå°‹">ğŸ”</span>
Â  Â  Â  </div>
Â  Â  Â  <div id="locationSwitchContainer" style="text-align: center; margin: 10px 0;">
Â  Â  Â  Â  <label class="switch">
Â  Â  Â  Â  Â  <input type="checkbox" id="toggleUseLocation" />
Â  Â  Â  Â  Â  <span class="slider"></span>
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <span style="margin-left:10px;">ä½¿ç”¨å®šä½</span>
Â  Â  Â  </div>
Â  Â  Â  <div id="results"></div>
Â  Â  Â  <div id="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
Â  Â  Â  <div class="overlay"></div>
Â  Â  Â  <div class="modal" id="permissionModal">
Â  Â  Â  Â  <p id="modalText"></p>
Â  Â  Â  Â  <button id="modalButton">ç¢ºå®š</button>
Â  Â  Â  </div>
Â  Â  Â  <a href="https://github.com/potatosserver/YouBike" target="_blank" title="GitHub Repository">
Â  Â  Â  Â  <button id="githubButton" style="position: fixed; bottom: 80px; right: 20px; z-index: 1000; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
Â  Â  Â  Â  Â  <img src="https://potatosserver.github.io/YouBike/icons/github.png" alt="GitHub" style="width:35px; height:35px;" />
Â  Â  Â  Â  </button>
Â  Â  Â  </a>
Â  Â  Â  <button id="installButton" style="position: fixed; bottom: 140px; right: 20px; z-index: 1000; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
Â  Â  Â  Â  <img src="https://potatosserver.github.io/YouBike/icons/install.png" alt="å®‰è£" style="width:45px; height:45px;" />
Â  Â  Â  </button>
Â  Â  Â  <button id="toggleDarkMode" title="åˆ‡æ›æš—è‰²æ¨¡å¼">ğŸŒ™</button>
Â  Â  </div>
Â  Â  <script>
Â  Â  Â  let userLocation = null;
Â  Â  Â  let sortingLocked = false;
Â  Â  Â  let initialLoad = true;
Â  Â  Â  let locationDenied = false;
Â  Â  Â  let geolocationErrorMessage = null;
Â  Â  Â  let dataLoaded = false; // æ–°å¢ï¼šè¨˜éŒ„è³‡æ–™æ˜¯å¦å·²è¼‰å…¥å®Œæˆ
Â  Â  Â  const defaultLatitude = 22.6315725;
Â  Â  Â  const defaultLongitude = 120.3025079;
Â  Â  Â  const overlay = document.querySelector('.overlay');
Â  Â  Â  const modal = document.querySelector('.modal');
Â  Â  Â  const modalText = document.getElementById('modalText');
Â  Â  Â  const modalButton = document.getElementById('modalButton');
Â  Â  Â  const resultsDiv = document.getElementById('results');
Â  Â  Â  const loadingDiv = document.getElementById('loading');
Â  Â  Â  const keywordInput = document.getElementById('keyword');
Â  Â  Â  const maxResults = 100;
Â  Â  Â  const defaultSearchArea = "";
Â  Â  Â  const pinnedStations = new Set(JSON.parse(localStorage.getItem('pinnedStations') || '[]'));
Â  Â  Â  const useLocationSetting = localStorage.getItem("useLocation");
Â  Â  Â  const useLocation = useLocationSetting === null ? true : useLocationSetting === "true";
Â  Â  Â  document.getElementById('toggleUseLocation').checked = useLocation;
Â  Â  Â  document.getElementById('toggleUseLocation').addEventListener('change', function () {
Â  Â  Â  Â  localStorage.setItem("useLocation", this.checked);
Â  Â  Â  Â  if (this.checked) {
Â  Â  Â  Â  Â  sortingLocked = true;
Â  Â  Â  Â  Â  getLocation();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
Â  Â  Â  Â  Â  searchYouBike();
Â  Â  Â  Â  Â  updateVehicleData();
Â  Â  Â  Â  Â  setTimeout(updateResultsOrder, 1500);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  function togglePinStation(stationId, event) {
Â  Â  Â  Â  event.stopPropagation();
Â  Â  Â  Â  if (pinnedStations.has(stationId)) {
Â  Â  Â  Â  Â  pinnedStations.delete(stationId);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  pinnedStations.add(stationId);
Â  Â  Â  Â  }
Â  Â  Â  Â  localStorage.setItem('pinnedStations', JSON.stringify([...pinnedStations]));
Â  Â  Â  Â  const pinButton = document.querySelector(`.pin-button[data-id="${stationId}"]`);
Â  Â  Â  Â  if (pinButton) {
Â  Â  Â  Â  Â  pinButton.classList.toggle('pinned');
Â  Â  Â  Â  Â  pinButton.textContent = pinnedStations.has(stationId) ? 'â˜…' : 'â˜†';
Â  Â  Â  Â  }
Â  Â  Â  Â  updateResultsOrder();
Â  Â  Â  }
Â  Â  Â  let mainContentShown = false;
Â  Â  Â  function showMainContent() {
Â  Â  Â  Â  if (!mainContentShown) {
Â  Â  Â  Â  Â  const overlay = document.getElementById("loadingOverlay");
Â  Â  Â  Â  Â  const mainContent = document.getElementById("mainContent");
Â  Â  Â  Â  Â  if (navigator.onLine) {
Â  Â  Â  Â  Â  Â  // ç·šä¸Šæ¨¡å¼ï¼ŒåŸæœ‰å‹•ç•«
Â  Â  Â  Â  Â  Â  overlay.style.opacity = "0";
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  overlay.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  mainContent.style.display = "block";
Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // é›¢ç·šæ¨¡å¼ï¼Œæ›´æ–°è¨Šæ¯ä¸¦å»¶å¾Œéš±è—
Â  Â  Â  Â  Â  Â  document.getElementById("loadingText").textContent = "é›¢ç·šæ¨¡å¼å•Ÿå‹•ä¸­...";
Â  Â  Â  Â  Â  Â  overlay.style.opacity = "1"; // ç¢ºä¿ Loading ç•«é¢æ¸…æ™°å¯è¦‹
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  overlay.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  mainContent.style.display = "block";
Â  Â  Â  Â  Â  Â  }, 3000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  mainContentShown = true;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  (function simulateLoadingPercentage() {
Â  Â  Â  Â  const loadingText = document.getElementById("loadingText");
Â  Â  Â  Â  let progress = 0;
Â  Â  Â  Â  let lockedProgress = null;
Â  Â  Â  Â  loadingTextInterval = setInterval(() => {
Â  Â  Â  Â  Â  if (!mainContentShown) {
Â  Â  Â  Â  Â  Â  if (progress < 85) {
Â  Â  Â  Â  Â  Â  Â  progress++;
Â  Â  Â  Â  Â  Â  Â  loadingText.textContent = "è¼‰å…¥ä¸­ï¼š" + progress + "%";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  if (lockedProgress === null) {
Â  Â  Â  Â  Â  Â  Â  Â  lockedProgress = 85 + Math.floor(Math.random() * 11);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  loadingText.textContent = "è¼‰å…¥ä¸­ï¼š" + lockedProgress + "%";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  clearInterval(loadingTextInterval);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 50);
Â  Â  Â  })();
Â  Â  Â  let youbikeDataCache = null; // ç”¨æ–¼ç·©å­˜ YouBike API çš„è³‡æ–™

Â  Â  Â  async function searchYouBike(showLoadingIndicator = true) {
Â  Â  Â  Â  if (showLoadingIndicator) showLoading();
Â  Â  Â  Â  const keyword = keywordInput.value.trim().toLowerCase();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // æ–°å¢é›¢ç·šæ¨¡å¼åˆ¤æ–·èˆ‡å¿«å–è®€å–
Â  Â  Â  Â  Â  if (navigator.onLine) {
Â  Â  Â  Â  Â  Â  if (!youbikeDataCache) {
Â  Â  Â  Â  Â  Â  Â  // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚è«‹æ±‚ YouBike API (ä½¿ç”¨æ‚¨æä¾›çš„ Python è…³æœ¬ä¸­çš„ API)
Â  Â  Â  Â  Â  Â  Â  const youbikeApiUrl = "https://apis.youbike.com.tw/json/station-min-yb2.json";
Â  Â  Â  Â  Â  Â  Â  const youbikeResponse = await fetch(youbikeApiUrl, {
Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  'accept': '*/*',
Â  Â  Â  Â  Â  Â  Â  Â  Â  'accept-language': 'zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-CN;q=0.6',
Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ³¨æ„ï¼šOrigin å’Œ Referer åœ¨å‰ç«¯ç›´æ¥è¨­ç½®å¯èƒ½å—é™ï¼Œé€šå¸¸ç”±ç€è¦½å™¨è‡ªå‹•è™•ç†ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  // 'origin': 'https://www.youbike.com.tw', // å¦‚æœéœ€è¦ï¼Œè«‹å–æ¶ˆè¨»è§£ä¸¦ä¿®æ”¹
Â  Â  Â  Â  Â  Â  Â  Â  Â  // 'referer': 'https://www.youbike.com.tw/', // å¦‚æœéœ€è¦ï¼Œè«‹å–æ¶ˆè¨»è§£ä¸¦ä¿®æ”¹
Â  Â  Â  Â  Â  Â  Â  Â  Â  'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36', // å¯é¸çš„ user-agent
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  if (!youbikeResponse.ok) throw new Error(`HTTP error! status: ${youbikeResponse.status}`);
Â  Â  Â  Â  Â  Â  Â  const youbikeData = await youbikeResponse.json();

Â  Â  Â  Â  Â  Â  Â  // ***** é€™è£¡éœ€è¦æ ¹æ“š youbikeData çš„å¯¦éš›çµæ§‹ä¾†å–å¾—ç«™é»è³‡æ–™é™£åˆ— *****
Â  Â  Â  Â  Â  Â  Â  // å‡è¨­ youbikeData ç›´æ¥æ˜¯ä¸€å€‹ç«™é»ç‰©ä»¶çš„é™£åˆ—ï¼Œä¾‹å¦‚: [{ sno: "...", sna: "...", ... }, ...]
Â  Â  Â  Â  Â  Â  Â  // å¦‚æœè³‡æ–™è¢«åŒ…è£¹åœ¨å…¶ä»–å±¬æ€§ä¸­ï¼Œä¾‹å¦‚ youbikeData.data.stationsï¼Œè«‹ä¿®æ”¹ä¸‹æ–¹é€™è¡Œ
Â  Â  Â  Â  Â  Â  Â  youbikeDataCache = youbikeData || [];

Â  Â  Â  Â  Â  Â  Â  // å°‡å–å¾—çš„è³‡æ–™å„²å­˜è‡³ localStorage
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('cachedYouBikeData', JSON.stringify(youbikeDataCache)); // æ›´æ”¹ localStorage çš„ key åç¨±
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // å¾ localStorage è®€å–ä¹‹å‰å„²å­˜çš„ YouBike API è³‡æ–™
Â  Â  Â  Â  Â  Â  if (!youbikeDataCache) {
Â  Â  Â  Â  Â  Â  Â  youbikeDataCache = JSON.parse(localStorage.getItem('cachedYouBikeData') || '[]'); // æ›´æ”¹ localStorage çš„ key åç¨±
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  let filteredStations = youbikeDataCache; // æ›´æ”¹è®Šæ•¸åä»¥åæ˜ æ˜¯ YouBike è³‡æ–™

Â  Â  Â  Â  Â  if (keyword) {
Â  Â  Â  Â  Â  Â  filteredStations = filteredStations.filter(station => {
Â  Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´å±¬æ€§åç¨± (ä¾‹å¦‚ sno, sna, ar) *****
Â  Â  Â  Â  Â  Â  Â  const stationName = station.sna ? station.sna.toLowerCase() : ''; // å‡è¨­ç«™é»åç¨±å±¬æ€§æ˜¯ sna
Â  Â  Â  Â  Â  Â  Â  const stationAddress = station.ar ? station.ar.toLowerCase() : ''; // å‡è¨­ç«™é»åœ°å€å±¬æ€§æ˜¯ ar
Â  Â  Â  Â  Â  Â  Â  return stationName.includes(keyword) || stationAddress.includes(keyword);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // æŒ‰è·é›¢æ’åº (å¦‚æœä½¿ç”¨å®šä½)
Â  Â  Â  Â  Â  filteredStations.sort((a, b) => {
Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´åº§æ¨™å±¬æ€§åç¨± (lat, lng) *****
Â  Â  Â  Â  Â  Â  const distA = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  a.lat, b.lat // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  const distB = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  b.lat, b.lng // å‡è¨­ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  return distA - distB;
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  let limit = keyword ? 50 : 20;
Â  Â  Â  Â  Â  let usedStations;

Â  Â  Â  Â  Â  // è™•ç†é‡˜é¸å’Œéé‡˜é¸ç«™é»çš„é‚è¼¯ (ä¿æŒåŸæœ‰çš„æ’åºå’Œç¯©é¸é‚è¼¯ï¼Œä½†ä½¿ç”¨æ–°çš„ç«™é»è³‡æ–™)
Â  Â  Â  Â  Â  if (!keyword) {
Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´ç«™é» ID å±¬æ€§åç¨± (sno) *****
Â  Â  Â  Â  Â  Â  const pinnedFromLocal = filteredStations.filter(station => pinnedStations.has(String(station.sno))); // å‡è¨­ç«™é» ID å±¬æ€§æ˜¯ sno
Â  Â  Â  Â  Â  Â  const unpinned = filteredStations.filter(station => !pinnedStations.has(String(station.sno))); // å‡è¨­ç«™é» ID å±¬æ€§æ˜¯ sno

Â  Â  Â  Â  Â  Â  pinnedFromLocal.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´åº§æ¨™å±¬æ€§åç¨± (lat, lng) *****
Â  Â  Â  Â  Â  Â  Â  const distA = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  a.lat, a.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  const distB = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  b.lat, b.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  return distA - distB;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  unpinned.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´åº§æ¨™å±¬æ€§åç¨± (lat, lng) *****
Â  Â  Â  Â  Â  Â  Â  const distA = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  a.lat, a.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  const distB = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  b.lat, b.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  return distA - distB;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  usedStations = [...pinnedFromLocal, ...unpinned].slice(0, limit);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  usedStations = filteredStations.slice(0, limit);
Â  Â  Â  Â  Â  Â  const pinnedList = usedStations.filter(station => pinnedStations.has(String(station.sno))); // å‡è¨­ç«™é» ID å±¬æ€§æ˜¯ sno
Â  Â  Â  Â  Â  Â  const nonPinnedList = usedStations.filter(station => !pinnedStations.has(String(station.sno))); // å‡è¨­ç«™é» ID å±¬æ€§æ˜¯ sno

Â  Â  Â  Â  Â  Â  pinnedList.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´åº§æ¨™å±¬æ€§åç¨± (lat, lng) *****
Â  Â  Â  Â  Â  Â  Â  const distA = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  a.lat, a.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  const distB = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  b.lat, b.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  return distA - distB;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  nonPinnedList.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´åº§æ¨™å±¬æ€§åç¨± (lat, lng) *****
Â  Â  Â  Â  Â  Â  Â  const distA = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  a.lat, a.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  const distB = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  Â  b.lat, b.lng // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  return distA - distB;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  usedStations = [...pinnedList, ...nonPinnedList];
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  // ç²å–è»Šè¼›å¯¦æ™‚æ•¸æ“š (å¦‚æœæ‚¨éœ€è¦é€™å€‹åŠŸèƒ½ä¸” API æ­£å¸¸)
Â  Â  Â  Â  Â  const isOnline = navigator.onLine;
Â  Â  Â  Â  Â  let vehData = {};
Â  Â  Â  Â  Â  // ***** è«‹æ ¹æ“šæ–°çš„ API è³‡æ–™çµæ§‹èª¿æ•´ç«™é» ID å±¬æ€§åç¨± (sno) *****
Â  Â  Â  Â  Â  const stationIds = usedStations.map(station => String(station.sno)); // å‡è¨­ç«™é» ID å±¬æ€§æ˜¯ sno
Â  Â  Â  Â  Â  if (isOnline) {
Â  Â  Â  Â  Â  Â  // å¦‚æœæ‚¨éœ€è¦å¯¦æ™‚è»Šè¼›æ•¸æ“šä¸” queryVehicleData ä½¿ç”¨çš„ API æ­£å¸¸ï¼Œä¿ç•™é€™è¡Œ
Â  Â  Â  Â  Â  Â  vehData = await queryVehicleData(stationIds);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const organizedOutput = usedStations.map(site => {
Â  Â  Â  Â  Â  Â  const info = {
Â  Â  Â  Â  Â  Â  Â  // ***** åœ¨é€™è£¡æ ¹æ“šæ–°çš„ YouBike API è³‡æ–™çµæ§‹å–å¾—å°æ‡‰çš„å€¼ *****
Â  Â  Â  Â  Â  Â  Â  id: String(site.sno), // å‡è¨­ç«™é» ID å±¬æ€§æ˜¯ sno
Â  Â  Â  Â  Â  Â  Â  name: site.sna, // å‡è¨­ç«™é»åç¨±å±¬æ€§æ˜¯ sna
Â  Â  Â  Â  Â  Â  Â  coords: [site.lat, site.lng], // å‡è¨­ç·¯åº¦å±¬æ€§æ˜¯ lat, ç¶“åº¦å±¬æ€§æ˜¯ lng
Â  Â  Â  Â  Â  Â  Â  district: site.sarea, // å‡è¨­å€åŸŸå±¬æ€§æ˜¯ sarea
Â  Â  Â  Â  Â  Â  Â  address: site.ar // å‡è¨­åœ°å€å±¬æ€§æ˜¯ ar
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const vehicle = isOnline ? (Object.entries(vehData).find(([key]) => key === info.id)?.[1] || {}) : {};
Â  Â  Â  Â  Â  Â  return { station_info: info, vehicle_info: vehicle };
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // å°‡ä¸‹åˆ—é‡å»º DOM çš„é‚è¼¯æ”¹æˆæ›´æ–°å·²å­˜åœ¨çš„ DOM
Â  Â  Â  Â  Â  // åŸæœ¬çš„ï¼š resultsDiv.innerHTML = ''; ... å»ºç«‹æ‰€æœ‰å¡ç‰‡ ...
Â  Â  Â  Â  Â  organizedOutput.forEach(item => {
Â  Â  Â  Â  Â  Â  const station = item.station_info;
Â  Â  Â  Â  Â  Â  const vehicle = item.vehicle_info;
Â  Â  Â  Â  Â  Â  let card = document.querySelector(`.station[data-id="${station.id}"]`);
Â  Â  Â  Â  Â  Â  const pinButtonHtml = `<span class="pin-button ${pinnedStations.has(station.id) ? 'pinned' : ''}" data-id="${station.id}" onclick="togglePinStation('${station.id}', event)">${pinnedStations.has(station.id) ? 'â˜…' : 'â˜†'}</span>`;
Â  Â  Â  Â  Â  Â  const distance = calculateDistance(
Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  Â  station.coords[0],
Â  Â  Â  Â  Â  Â  Â  station.coords[1]
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  const displayDistance = distance < 1 ? Math.round(distance * 1000) + " å…¬å°º" : distance.toFixed(2) + " å…¬é‡Œ";
Â  Â  Â  Â  Â  Â  const vehicleInfoHtml = isOnline ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>YouBike 2.0: <span class="vehicle_yb2">${vehicle?.available_2_0 !== undefined ? vehicle.available_2_0 : 'æœªçŸ¥'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>YouBike 2.0E: <span class="vehicle_ybe">${vehicle?.available_e !== undefined ? vehicle.available_e : 'æœªçŸ¥'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>å¯åœç©ºä½æ•¸: <span class="vehicle_empty">${vehicle?.empty_spaces !== undefined ? vehicle.empty_spaces : 'æœªçŸ¥'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ` : '';
Â  Â  Â  Â  Â  Â  const cardContent = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${pinButtonHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>${station.name || 'æœªçŸ¥ç«™é»'}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="distance">è·é›¢: ${displayDistance}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>åœ°å€: ${station.address || 'æœªçŸ¥åœ°å€'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${vehicleInfoHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  if (card) {
Â  Â  Â  Â  Â  Â  Â  // æ›´æ–°å·²å­˜åœ¨å¡ç‰‡
Â  Â  Â  Â  Â  Â  Â  card.innerHTML = cardContent;
Â  Â  Â  Â  Â  Â  Â  card.dataset.lat = station.coords[0];
Â  Â  Â  Â  Â  Â  Â  card.dataset.lng = station.coords[1];
Â  Â  Â  Â  Â  Â  Â  card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  // å»ºç«‹æ–°çš„å¡ç‰‡
Â  Â  Â  Â  Â  Â  Â  card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  card.className = 'station';
Â  Â  Â  Â  Â  Â  Â  card.dataset.id = station.id;
Â  Â  Â  Â  Â  Â  Â  card.dataset.lat = station.coords[0];
Â  Â  Â  Â  Â  Â  Â  card.dataset.lng = station.coords[1];
Â  Â  Â  Â  Â  Â  Â  card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
Â  Â  Â  Â  Â  Â  Â  card.innerHTML = cardContent;
Â  Â  Â  Â  Â  Â  Â  card.addEventListener("click", () => {
Â  Â  Â  Â  Â  Â  Â  Â  const lat = parseFloat(station.coords[0]), lng = parseFloat(station.coords[1]);
Â  Â  Â  Â  Â  Â  Â  Â  if (!isNaN(lat) && !isNaN(lng)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  // ***** é€™è£¡çš„ Google Maps é€£çµå¯èƒ½éœ€è¦èª¿æ•´ï¼Œç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„åº§æ¨™æ ¼å¼ *****
Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank");
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showModal("ç«™é»åº§æ¨™ç„¡æ•ˆï¼Œç„¡æ³•é–‹å•Ÿåœ°åœ–ã€‚");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  resultsDiv.appendChild(card);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  // ç§»é™¤ä¸å†å­˜åœ¨çš„å¡ç‰‡
Â  Â  Â  Â  Â  const validIds = organizedOutput.map(item => item.station_info.id);
Â  Â  Â  Â  Â  Array.from(resultsDiv.children).forEach(card => {
Â  Â  Â  Â  Â  Â  if (!validIds.includes(card.dataset.id)) {
Â  Â  Â  Â  Â  Â  Â  resultsDiv.removeChild(card);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  updateResultsOrder();

Â  Â  Â  Â  Â  // æ–°å¢ï¼šç­‰å¾…ä¸€æ¬¡äº‹ä»¶è¿´åœˆï¼Œç¢ºä¿å¡ç‰‡ DOM æ›´æ–°å®Œæˆ
Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, 0));

Â  Â  Â  Â  Â  dataLoaded = true; // è³‡æ–™å·²è¼‰å…¥å®Œæˆ
Â  Â  Â  Â  Â  if (showLoadingIndicator) {
Â  Â  Â  Â  Â  Â  // åƒ…åœ¨æ‰‹å‹•è§¸ç™¼æ™‚é¡¯ç¤º mainContentï¼Œé¿å…è‡ªå‹•æ›´æ–°æ™‚æ²å‹•ç•«é¢
Â  Â  Â  Â  Â  Â  showMainContent();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("Fetch error:", error);
Â  Â  Â  Â  Â  resultsDiv.innerHTML = `ç™¼ç”ŸéŒ¯èª¤: ç„¡æ³•è¼‰å…¥ç«™é»è³‡æ–™ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚è©³ç´°éŒ¯èª¤: ${error.message}`; // æä¾›æ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  if (showLoadingIndicator) hideLoading();
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  // é€™å€‹å‡½å¼ä¼¼ä¹ç”¨æ–¼ç²å–å¯¦æ™‚è»Šè¼›æ•¸æ“šï¼ŒAPI åœ°å€å’Œé‚è¼¯èˆ‡æ‚¨æä¾›çš„ Python è…³æœ¬ä¸åŒã€‚
Â  Â  Â  // å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨æ‚¨æä¾›çš„ Python è…³æœ¬ä¸­çš„ API ä¾†ç²å–æ‰€æœ‰ç«™é»è³‡è¨Šï¼Œ
Â  Â  Â  // ä¸¦ä¸”è©² API ä¸åŒ…å«å¯¦æ™‚è»Šè¼›æ•¸æ“šï¼Œæ‚¨å¯èƒ½éœ€è¦ç§»é™¤æˆ–ä¿®æ”¹é€™å€‹å‡½å¼ã€‚
Â  Â  Â  // å¦‚æœæ‚¨éœ€è¦çµåˆå…©å€‹ API (ä¸€å€‹ç²å–ç«™é»è³‡è¨Šï¼Œä¸€å€‹ç²å–å¯¦æ™‚è»Šè¼›æ•¸æ“š)ï¼Œ
Â  Â  Â  // å‰‡éœ€è¦ç¢ºä¿é€™è£¡çš„ API åœ°å€å’Œè™•ç†é‚è¼¯æ­£ç¢ºã€‚
Â  Â  Â  async function queryVehicleData(stationIds) {
Â  Â  Â  Â  if (stationIds.length > 60) {
Â  Â  Â  Â  Â  stationIds = stationIds.slice(0, 60);
Â  Â  Â  Â  }
Â  Â  Â  Â  const batchSize = 20;
Â  Â  Â  Â  const allVehicleData = {};
Â  Â  Â  Â  // è«‹ç¢ºèªé€™å€‹ API åœ°å€ (https://apis.youbike.com.tw/tw2/parkingInfo) æ˜¯å¦æ­£å¸¸å·¥ä½œ
Â  Â  Â  Â  // å¦‚æœéœ€è¦ä¿®æ”¹ Headersï¼Œè«‹åœ¨é€™è£¡èª¿æ•´
Â  Â  Â  Â  const headers = {
Â  Â  Â  Â  Â  'Accept': '*/*',
Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  'Origin': 'https://www.youbike.com.tw', // è«‹æ ¹æ“šæ‚¨çš„ç¶²ç«™ä¾†æºå’Œ API è¦æ±‚ä¿®æ”¹
Â  Â  Â  Â  Â  'Referer': 'https://www.youbike.com.tw/' // è«‹æ ¹æ“šæ‚¨çš„ç¶²ç«™ Referer å’Œ API è¦æ±‚ä¿®æ”¹
Â  Â  Â  Â  };
Â  Â  Â  Â  for (let i = 0; i < stationIds.length; i += batchSize) {
Â  Â  Â  Â  Â  const stationIdBatch = stationIds.slice(i, i + batchSize);
Â  Â  Â  Â  Â  const body = JSON.stringify({ station_no: stationIdBatch });
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch('https://apis.youbike.com.tw/tw2/parkingInfo', {
Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  headers,
Â  Â  Â  Â  Â  Â  Â  body
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  if (result.retCode === 1 && result.retVal && result.retVal.data) {
Â  Â  Â  Â  Â  Â  Â  const dataArray = result.retVal.data;
Â  Â  Â  Â  Â  Â  Â  dataArray.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  allVehicleData[item.station_no] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  available_2_0: item.available_spaces_detail ? item.available_spaces_detail.yb2 : 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  available_e: item.available_spaces_detail ? item.available_spaces_detail.eyb : 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  empty_spaces: item.empty_spaces || 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.error("API è«‹æ±‚å¤±æ•—:", result.retMsg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return allVehicleData;
Â  Â  Â  }

Â  Â  Â  function updateResultsOrder() {
Â  Â  Â  Â  const cards = Array.from(document.querySelectorAll(".station"));
Â  Â  Â  Â  cards.sort((a, b) => {
Â  Â  Â  Â  Â  const aPinned = pinnedStations.has(a.dataset.id);
Â  Â  Â  Â  Â  const bPinned = pinnedStations.has(b.dataset.id);
Â  Â  Â  Â  Â  if (aPinned && !bPinned) return -1;
Â  Â  Â  Â  Â  if (!aPinned && bPinned) return 1;
Â  Â  Â  Â  Â  const distanceA = calculateDistance(
Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  parseFloat(a.dataset.lat),
Â  Â  Â  Â  Â  Â  parseFloat(a.dataset.lng)
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  const distanceB = calculateDistance(
Â  Â  Â  Â  Â  Â  userLocation ? userLocation.latitude : defaultLatitude,
Â  Â  Â  Â  Â  Â  userLocation ? userLocation.longitude : defaultLongitude,
Â  Â  Â  Â  Â  Â  parseFloat(b.dataset.lat),
Â  Â  Â  Â  Â  Â  parseFloat(b.dataset.lng)
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  return distanceA - distB;
Â  Â  Â  Â  });
Â  Â  Â  Â  cards.forEach(card => {
Â  Â  Â  Â  Â  resultsDiv.appendChild(card);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  function showLoading() {
Â  Â  Â  Â  loadingDiv.classList.add('show');
Â  Â  Â  }
Â  Â  Â  function hideLoading() {
Â  Â  Â  Â  loadingDiv.classList.remove('show');
Â  Â  Â  }
Â  Â  Â  function showModal(message) {
Â  Â  Â  Â  modalText.textContent = message;
Â  Â  Â  Â  overlay.classList.add('show');
Â  Â  Â  Â  modal.classList.add('show');
Â  Â  Â  }
Â  Â  Â  function hideModal() {
Â  Â  Â  Â  overlay.classList.remove('show');
Â  Â  Â  Â  modal.classList.remove('show');
Â  Â  Â  }
Â  Â  Â  function calculateDistance(lat1, lon1, lat2, lon2) {
Â  Â  Â  Â  const R = 6371;
Â  Â  Â  Â  const dLat = (lat2 - lat1) * Math.PI / 180;
Â  Â  Â  Â  const dLon = (lon2 - lon1) * Math.PI / 180;
Â  Â  Â  Â  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
Â  Â  Â  Â  Â  Â  Â  Â  Â  Math.sin(dLon / 2) * Math.sin(dLon / 2);
Â  Â  Â  Â  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
Â  Â  Â  Â  return R * c;
Â  Â  Â  }
Â  Â  Â  async function handleGeolocationSuccess(position) {
Â  Â  Â  Â  const wasDefault = !userLocation || (userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude);
Â  Â  Â  Â  userLocation = {
Â  Â  Â  Â  Â  latitude: position.coords.latitude,
Â  Â  Â  Â  Â  longitude: position.coords.longitude
Â  Â  Â  Â  };
Â  Â  Â  Â  if (wasDefault) {
Â  Â  Â  Â  Â  await searchYouBike();
Â  Â  Â  Â  Â  updateResultsOrder();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  updateCardDistances();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  function handleGeolocationError(error) {
Â  Â  Â  Â  console.error("Geolocation error:", error);
Â  Â  Â  Â  locationDenied = true;
Â  Â  Â  Â  let errorMessage = "";
Â  Â  Â  Â  switch (error.code) {
Â  Â  Â  Â  Â  case error.PERMISSION_DENIED:
Â  Â  Â  Â  Â  Â  errorMessage = "æœªæä¾›å®šä½æ¬Šé™ï¼Œå°‡ä½¿ç”¨æ·é‹ç¾éº—å³¶ç«™ä½œç‚ºä¸­å¿ƒå®šä½ã€‚";
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case error.POSITION_UNAVAILABLE:
Â  Â  Â  Â  Â  Â  errorMessage = "å®šä½è³‡è¨Šä¸å¯ç”¨ï¼Œå°‡ä½¿ç”¨æ·é‹ç¾éº—å³¶ç«™ä½œç‚ºä¸­å¿ƒå®šä½ç›´åˆ°å®šä½æˆåŠŸã€‚";
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case error.TIMEOUT:
Â  Â  Â  Â  Â  Â  errorMessage = "å®šä½é€¾æ™‚ï¼Œå°‡ä½¿ç”¨æ·é‹ç¾éº—å³¶ç«™ä½œç‚ºä¸­å¿ƒå®šä½ç›´åˆ°å®šä½æˆåŠŸã€‚";
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  errorMessage = "å®šä½éŒ¯èª¤ï¼Œå°‡ä½¿ç”¨æ·é‹ç¾éº—å³¶ç«™ä½œç‚ºä¸­å¿ƒå®šä½ç›´åˆ°å®šä½æˆåŠŸã€‚";
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  Â  showModal(errorMessage);
Â  Â  Â  Â  userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
Â  Â  Â  Â  searchYouBike();
Â  Â  Â  }
Â  Â  Â  function handleGeoUpdateSuccess(position) {
Â  Â  Â  Â  const wasDefault = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
Â  Â  Â  Â  userLocation = {
Â  Â  Â  Â  Â  latitude: position.coords.latitude,
Â  Â  Â  Â  Â  longitude: position.coords.longitude
Â  Â  Â  Â  };
Â  Â  Â  Â  if (wasDefault) {
Â  Â  Â  Â  Â  searchYouBike().then(() => {
Â  Â  Â  Â  Â  Â  updateResultsOrder();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  updateCardDistances();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  function handleGeoUpdateError(error) {
Â  Â  Â  Â  console.error("Geolocation update error:", error);
Â  Â  Â  }
Â  Â  Â  function getLocation() {
Â  Â  Â  Â  if (!document.getElementById('toggleUseLocation').checked) {
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (navigator.geolocation) {
Â  Â  Â  Â  Â  // ç²å–ä¸€æ¬¡æ€§å®šä½
Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  handleGeolocationSuccess,
Â  Â  Â  Â  Â  Â  handleGeolocationError,
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  enableHighAccuracy: true,
Â  Â  Â  Â  Â  Â  Â  timeout: 10000,
Â  Â  Â  Â  Â  Â  Â  maximumAge: 60000
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  // è¨­ç½®æŒçºŒç›£è½å®šä½è®ŠåŒ–
Â  Â  Â  Â  Â  navigator.geolocation.watchPosition(
Â  Â  Â  Â  Â  Â  handleGeoUpdateSuccess,
Â  Â  Â  Â  Â  Â  handleGeoUpdateError,
Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  enableHighAccuracy: true,
Â  Â  Â  Â  Â  Â  Â  timeout: 10000,
Â  Â  Â  Â  Â  Â  Â  maximumAge: 0
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  handleGeolocationError({ code: 0, message: "ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚" });
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  function updateCardDistances() {
Â  Â  Â  Â  if (!userLocation) return;
Â  Â  Â  Â  const cards = document.querySelectorAll(".station");
Â  Â  Â  Â  cards.forEach(card => {
Â  Â  Â  Â  Â  const stationLat = parseFloat(card.dataset.lat);
Â  Â  Â  Â  Â  const stationLng = parseFloat(card.dataset.lng);
Â  Â  Â  Â  Â  if (!isNaN(stationLat) && !isNaN(stationLng)) {
Â  Â  Â  Â  Â  Â  const distance = calculateDistance(userLocation.latitude, userLocation.longitude, stationLat, stationLng);
Â  Â  Â  Â  Â  Â  const displayDistance = distance < 1 ? Math.round(distance * 1000) + " å…¬å°º" : distance.toFixed(2) + " å…¬é‡Œ";
Â  Â  Â  Â  Â  Â  const distanceElement = card.querySelector(".distance");
Â  Â  Â  Â  Â  Â  if (distanceElement) {
Â  Â  Â  Â  Â  Â  Â  distanceElement.textContent = `è·é›¢: ${displayDistance}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // åˆå§‹åŒ–è¼‰å…¥
Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  // ç¢ºä¿å…ˆé¡¯ç¤ºè¼‰å…¥ç•«é¢
Â  Â  Â  Â  document.getElementById("loadingOverlay").style.display = "flex";
Â  Â  Â  Â  document.getElementById("loadingOverlay").style.opacity = "1";

Â  Â  Â  Â  // æª¢æŸ¥æ˜¯å¦æœ‰å¿«å–çš„ YouBike è³‡æ–™
Â  Â  Â  Â  const cachedData = localStorage.getItem('cachedYouBikeData');
Â  Â  Â  Â  if (cachedData) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  youbikeDataCache = JSON.parse(cachedData);
Â  Â  Â  Â  Â  Â  dataLoaded = true;
Â  Â  Â  Â  Â  Â  console.log("å¾å¿«å–è¼‰å…¥ç«™é»è³‡æ–™");
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("è§£æå¿«å–è³‡æ–™å¤±æ•—:", e);
Â  Â  Â  Â  Â  Â  youbikeDataCache = null;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (youbikeDataCache && youbikeDataCache.length > 0) {
Â  Â  Â  Â  Â  // å¦‚æœæœ‰å¿«å–è³‡æ–™ï¼Œå…ˆé¡¯ç¤ºå¿«å–çš„è³‡æ–™
Â  Â  Â  Â  Â  console.log("é¡¯ç¤ºå¿«å–ç«™é»è³‡æ–™");
Â  Â  Â  Â  Â  // é‡æ–°æ¸²æŸ“ç«™é»åˆ—è¡¨
Â  Â  Â  Â  Â  // é€™è£¡éœ€è¦å‘¼å«ä¸€å€‹å‡½å¼ä¾†æ ¹æ“š youbikeDataCache æ¸²æŸ“åˆ—è¡¨
Â  Â  Â  Â  Â  // æš«æ™‚å…ˆå‘¼å« searchYouBike()ï¼Œå®ƒæœƒä½¿ç”¨ youbikeDataCache
Â  Â  Â  Â  Â  await searchYouBike(false); // ä¸é¡¯ç¤ºé‡è¤‡çš„ loading

Â  Â  Â  Â  Â  // åœ¨èƒŒæ™¯æ›´æ–°è³‡æ–™
Â  Â  Â  Â  Â  if (navigator.onLine) {
Â  Â  Â  Â  Â  Â  console.log("èƒŒæ™¯æ›´æ–°ç«™é»è³‡æ–™");
Â  Â  Â  Â  Â  Â  await searchYouBike(false); // ä¸é¡¯ç¤º loadingï¼Œåªæ›´æ–°è³‡æ–™å’Œé¡¯ç¤º
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById("loadingText").textContent = "é›¢ç·šæ¨¡å¼å•Ÿå‹•ä¸­...";
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  showMainContent(); // é¡¯ç¤ºä¸»è¦å…§å®¹
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // å¦‚æœæ²’æœ‰å¿«å–è³‡æ–™ï¼Œæˆ–è€…å¿«å–è³‡æ–™ç„¡æ•ˆï¼Œå‰‡å¾ API ç²å–
Â  Â  Â  Â  Â  console.log("å¾ API è¼‰å…¥ç«™é»è³‡æ–™");
Â  Â  Â  Â  Â  await searchYouBike(true); // é¡¯ç¤º loading
Â  Â  Â  Â  }

Â  Â  Â  Â  // ç²å–ç”¨æˆ¶å®šä½ (å¦‚æœå•Ÿç”¨)
Â  Â  Â  Â  if (useLocation) {
Â  Â  Â  Â  Â  getLocation();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
Â  Â  Â  Â  Â  // å¦‚æœæ²’æœ‰ä½¿ç”¨å®šä½ï¼Œä¸¦ä¸”ç«™é»è³‡æ–™å·²ç¶“è¼‰å…¥ï¼Œå‰‡æ ¹æ“šé è¨­ä½ç½®æ’åºå’Œé¡¯ç¤º
Â  Â  Â  Â  Â  if (dataLoaded) {
Â  Â  Â  Â  Â  Â  updateResultsOrder();
Â  Â  Â  Â  Â  Â  updateCardDistances(); // æ›´æ–°å¡ç‰‡ä¸Šçš„è·é›¢é¡¯ç¤º
Â  Â  Â  Â  Â  Â  showMainContent();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // æ¯éš”ä¸€æ®µæ™‚é–“æ›´æ–°è»Šè¼›æ•¸æ“š (å¦‚æœ API æ­£å¸¸)
Â  Â  Â  Â  setInterval(updateVehicleData, 30000); // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡

Â  Â  Â  Â  // å…¶ä»–äº‹ä»¶ç›£è½å™¨
Â  Â  Â  Â  modalButton.addEventListener('click', hideModal);
Â  Â  Â  Â  keywordInput.addEventListener('input', searchYouBike); // ç•¶è¼¸å…¥æ¡†å…§å®¹æ”¹è®Šæ™‚è§¸ç™¼æœå°‹
Â  Â  Â  Â  document.getElementById('searchIcon').addEventListener('click', searchYouBike); // é»æ“Šæœå°‹åœ–ç¤ºè§¸ç™¼æœå°‹

Â  Â  Â  Â  // æš—è‰²æ¨¡å¼åˆ‡æ›
Â  Â  Â  Â  const toggleDarkModeButton = document.getElementById('toggleDarkMode');
Â  Â  Â  Â  const currentMode = localStorage.getItem('darkMode');
Â  Â  Â  Â  if (currentMode === 'enabled') {
Â  Â  Â  Â  Â  document.body.classList.add('dark-mode');
Â  Â  Â  Â  }
Â  Â  Â  Â  toggleDarkModeButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  document.body.classList.toggle('dark-mode');
Â  Â  Â  Â  Â  if (document.body.classList.contains('dark-mode')) {
Â  Â  Â  Â  Â  Â  localStorage.setItem('darkMode', 'enabled');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  localStorage.setItem('darkMode', 'disabled');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // å®‰è£ PWA æŒ‰éˆ•
Â  Â  Â  Â  let deferredPrompt;
Â  Â  Â  Â  const installButton = document.getElementById('installButton');

Â  Â  Â  Â  window.addEventListener('beforeinstallprompt', (e) => {
Â  Â  Â  Â  Â  // Prevent the mini-infobar from appearing on mobile
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  // Stash the event so it can be triggered later.
Â  Â  Â  Â  Â  deferredPrompt = e;
Â  Â  Â  Â  Â  // Update UI notify the user they can install the PWA
Â  Â  Â  Â  Â  installButton.style.display = 'flex';
Â  Â  Â  Â  });

Â  Â  Â  Â  installButton.addEventListener('click', async () => {
Â  Â  Â  Â  Â  // Hide the install button
Â  Â  Â  Â  Â  installButton.style.display = 'none';
Â  Â  Â  Â  Â  // Show the install prompt
Â  Â  Â  Â  Â  if (deferredPrompt) {
Â  Â  Â  Â  Â  Â  deferredPrompt.prompt();
Â  Â  Â  Â  Â  Â  // Wait for the user to respond to the prompt
Â  Â  Â  Â  Â  Â  const { outcome } = await deferredPrompt.userChoice;
Â  Â  Â  Â  Â  Â  // Optionally, send analytics event with outcome of user choice
Â  Â  Â  Â  Â  Â  console.log(`User response to the install prompt: ${outcome}`);
Â  Â  Â  Â  Â  Â  // We've used the prompt, and can't use it again, throw it away
Â  Â  Â  Â  Â  Â  deferredPrompt = null;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  window.addEventListener('appinstalled', () => {
Â  Â  Â  Â  Â  // Hide the install button
Â  Â  Â  Â  Â  installButton.style.display = 'none';
Â  Â  Â  Â  Â  // Clear the deferredPrompt so it can be garbage collected
Â  Â  Â  Â  Â  deferredPrompt = null;
Â  Â  Â  Â  Â  // Optionally, send analytics event to indicate successful install
Â  Â  Â  Â  Â  console.log('PWA was installed');
Â  Â  Â  Â  });
Â  Â  Â  });

Â  Â  Â  // æ¯éš”ä¸€æ®µæ™‚é–“æ›´æ–°è»Šè¼›æ•¸æ“šçš„å‡½å¼
Â  Â  Â  async function updateVehicleData() {
Â  Â  Â  Â  // ç¢ºä¿æœ‰ç«™é»è³‡æ–™ä¸”åœ¨ç·š
Â  Â  Â  Â  if (!youbikeDataCache || youbikeDataCache.length === 0 || !navigator.onLine) {
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // ç²å–ç•¶å‰é¡¯ç¤ºçš„ç«™é» ID
Â  Â  Â  Â  Â  const displayedStationIds = Array.from(document.querySelectorAll(".station")).map(card => card.dataset.id);

Â  Â  Â  Â  Â  // å‘¼å«ç²å–è»Šè¼›æ•¸æ“šçš„ API
Â  Â  Â  Â  Â  const vehData = await queryVehicleData(displayedStationIds);

Â  Â  Â  Â  Â  // æ›´æ–°é é¢ä¸Šçš„è»Šè¼›æ•¸æ“šé¡¯ç¤º
Â  Â  Â  Â  Â  displayedStationIds.forEach(stationId => {
Â  Â  Â  Â  Â  Â  const vehicleInfo = vehData[stationId];
Â  Â  Â  Â  Â  Â  if (vehicleInfo) {
Â  Â  Â  Â  Â  Â  Â  const card = document.querySelector(`.station[data-id="${stationId}"]`);
Â  Â  Â  Â  Â  Â  Â  if (card) {
Â  Â  Â  Â  Â  Â  Â  Â  const yb2Element = card.querySelector('.vehicle_yb2');
Â  Â  Â  Â  Â  Â  Â  Â  const ybeElement = card.querySelector('.vehicle_ybe');
Â  Â  Â  Â  Â  Â  Â  Â  const emptyElement = card.querySelector('.vehicle_empty');

Â  Â  Â  Â  Â  Â  Â  Â  if (yb2Element) yb2Element.textContent = vehicleInfo.available_2_0 !== undefined ? vehicleInfo.available_2_0 : 'æœªçŸ¥';
Â  Â  Â  Â  Â  Â  Â  Â  if (ybeElement) ybeElement.textContent = vehicleInfo.available_e !== undefined ? vehicleInfo.available_e : 'æœªçŸ¥';
Â  Â  Â  Â  Â  Â  Â  Â  if (emptyElement) emptyElement.textContent = vehicleInfo.empty_spaces !== undefined ? vehicleInfo.empty_spaces : 'æœªçŸ¥';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("æ›´æ–°è»Šè¼›æ•¸æ“šå¤±æ•—:", error);
Â  Â  Â  Â  }
Â  Â  Â  }


Â  Â  </script>
Â  </body>
</html>
