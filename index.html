<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>高雄 YouBike 站點搜尋</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="manifest" href="/YouBike/manifest.json" />
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
          navigator.serviceWorker
            .register("../YouBike/service-worker.js")
            .then(function (registration) {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(function (error) {
              console.error('Service Worker registration failed:', error);
            });
        });
      }
    </script>
    <style>
      body {
        font-family: 'Noto Sans TC', Arial, sans-serif;
        margin: 20px;
        background: #f4f4f4;
        transition: background 0.5s ease, color 0.5s ease;
      }
      h1 {
        color: #007BFF;
        text-align: center;
        margin-bottom: 20px;
      }
      #searchContainer {
        display: flex;
        align-items: center;
        margin-left: auto;
        margin-right: auto;
        max-width: 500px;
        width: 100%;
        position: relative;
      }
      #keyword {
        padding: 10px;
        width: 100%;
        padding-right: 10px;
        border: 1px solid #ccc;
        border-radius: 5px 0 0 5px;
        margin-right: 0;
        font-size: 16px;
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        word-wrap: break-word;
        overflow-wrap: break-word;
        display: block;
      }
      #keyword:focus {
        outline: none;
        border-color: #007BFF;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }
      #searchIcon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-65%);
      }
      #searchIcon:hover {
        color: #0056b3;
      }
      button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 0 5px 5px 0;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        margin-left: 0;
        width: auto;
        min-width: 50px;
        text-align: center;
        display: block;
      }
      button:hover {
        background-color: #0056b3;
      }
      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .station {
        background-color: white;
        border: 1px solid #e0e0e0;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: calc(33% - 20px);
        min-width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
        cursor: pointer;
        position: relative;
      }
      .station:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
      .station h3 {
        margin: 0 0 10px 0;
        color: #007BFF;
        font-size: 1.2em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding-right: 30px;
      }
      .station p {
        margin: 0 0 5px 0;
        color: #555;
        font-size: 1em;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .station .pin-button {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        background: none;
        border: none;
        cursor: pointer;
        color: #007BFF;
        transition: transform 0.2s ease, color 0.2s ease;
        width: auto;
        height: auto;
        border-radius: 0;
        display: inline;
      }
      .station .pin-button:hover {
        transform: scale(1.2);
        color: #0056b3;
      }
      .station .pin-button.pinned {
        color: #FFD700;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 1.2em;
        z-index: 10;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      #loading.show {
        opacity: 1;
        display: block;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .overlay.show {
        display: block;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        display: none;
      }
      .modal.show {
        display: block;
      }
      .modal button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .modal button:hover {
        background-color: #0056b3;
      }
      body.dark-mode {
        background: #333;
        color: #ffffff;
        transition: background 0.5s ease, color 0.5s ease;
      }
      body.dark-mode h1 {
        color: #90CAF9;
      }
      body.dark-mode #keyword {
        background-color: #1e1e1e;
        color: #ffffff;
        border-color: #90caf9;
      }
      body.dark-mode #keyword:focus {
        box-shadow: 0 0 5px rgba(144, 202, 249, 0.5);
      }
      body.dark-mode button {
        background-color: #90caf9;
        color: #121212;
      }
      body.dark-mode button:hover {
        background-color: #64b5f6;
      }
      body.dark-mode .station {
        background-color: #444;
        border-color: #555;
        color: #ffffff;
      }
      body.dark-mode .station h3 {
        color: #90CAF9;
      }
      body.dark-mode .station p {
        color: #cccccc;
      }
      body.dark-mode .modal {
        background-color: #333;
        color: #ffffff;
      }
      body.dark-mode .overlay {
        background-color: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode #loading {
        background: #ffffff;
        color: #000000;
      }
      body.dark-mode #loadingOverlay {
        background-color: rgba(51, 51, 51, 0.9);
      }
      body.dark-mode #loadingText {
        color: #ffffff;
      }
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #007BFF;
      }
      input:checked + .slider:before {
        transform: translateX(26px);
      }
      #githubButton img {
        display: block;
        margin: 0;
        width: 45px;
        height: 45px;
        object-fit: contain;
      }
      #installButton {
        position: fixed;
        bottom: 140px;
        right: 20px;
        z-index: 1000;
        width: 50px;
        height: 50px;
        background: white;
        color: black;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 0;
      }
      #installButton img {
        display: block;
        margin: 0 auto; 
        width: 45px;
        height: 45px;
        object-fit: contain;
      }
      
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
      <div id="loadingContent">
        <p id="loadingText">載入中</p>
      </div>
    </div>
    <div id="mainContent" style="display:none;">
      <h1>高雄 YouBike 搜尋</h1>
      <div id="searchContainer">
        <input type="text" id="keyword" placeholder="請輸入站點名稱、地址" value="" />
        <span id="searchIcon" title="搜尋">🔍</span>
      </div>
      <div id="locationSwitchContainer" style="text-align: center; margin: 10px 0;">
        <label class="switch">
          <input type="checkbox" id="toggleUseLocation" />
          <span class="slider"></span>
        </label>
        <span style="margin-left:10px;">使用定位</span>
      </div>
      <div id="results"></div>
      <div id="loading">載入中，請稍候...</div>
      <div class="overlay"></div>
      <div class="modal" id="permissionModal">
        <p id="modalText"></p>
        <button id="modalButton">確定</button>
      </div>
      <a href="https://github.com/potatosserver/YouBike" target="_blank" title="GitHub Repository">
        <button id="githubButton" style="position: fixed; bottom: 80px; right: 20px; z-index: 1000; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <img src="https://potatosserver.github.io/YouBike/icons/github.png" alt="GitHub" style="width:35px; height:35px;" />
        </button>
      </a>
      <button id="installButton" style="position: fixed; bottom: 140px; right: 20px; z-index: 1000; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
        <img src="https://potatosserver.github.io/YouBike/icons/install.png" alt="安裝" style="width:45px; height:45px;" />
      </button>
      <button id="toggleDarkMode" title="切換暗色模式">🌙</button>
    </div>
    <script>
      let userLocation = null;
      let sortingLocked = false;
      let initialLoad = true;
      let locationDenied = false;
      let geolocationErrorMessage = null;
      let dataLoaded = false; // 新增：記錄資料是否已載入完成
      const defaultLatitude = 22.6315725;
      const defaultLongitude = 120.3025079;
      const overlay = document.querySelector('.overlay');
      const modal = document.querySelector('.modal');
      const modalText = document.getElementById('modalText');
      const modalButton = document.getElementById('modalButton');
      const resultsDiv = document.getElementById('results');
      const loadingDiv = document.getElementById('loading');
      const keywordInput = document.getElementById('keyword');
      const maxResults = 100;
      const defaultSearchArea = "";
      const pinnedStations = new Set(JSON.parse(localStorage.getItem('pinnedStations') || '[]'));
      const useLocationSetting = localStorage.getItem("useLocation");
      const useLocation = useLocationSetting === null ? true : useLocationSetting === "true";
      document.getElementById('toggleUseLocation').checked = useLocation;
      document.getElementById('toggleUseLocation').addEventListener('change', function () {
        localStorage.setItem("useLocation", this.checked);
        if (this.checked) {
          sortingLocked = true;
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
          updateVehicleData();
          setTimeout(updateResultsOrder, 1500);
        }
      });
      function togglePinStation(stationId, event) {
        event.stopPropagation();
        if (pinnedStations.has(stationId)) {
          pinnedStations.delete(stationId);
        } else {
          pinnedStations.add(stationId);
        }
        localStorage.setItem('pinnedStations', JSON.stringify([...pinnedStations]));
        const pinButton = document.querySelector(`.pin-button[data-id="${stationId}"]`);
        if (pinButton) {
          pinButton.classList.toggle('pinned');
          pinButton.textContent = pinnedStations.has(stationId) ? '★' : '☆';
        }
        updateResultsOrder();
      }
      let mainContentShown = false;
      function showMainContent() {
        if (!mainContentShown) {
          const overlay = document.getElementById("loadingOverlay");
          const mainContent = document.getElementById("mainContent");
          if (navigator.onLine) {
            // 線上模式，原有動畫
            overlay.style.opacity = "0";
            setTimeout(() => {
              overlay.style.display = "none";
              mainContent.style.display = "block";
            }, 500);
          } else {
            // 離線模式，更新訊息並延後隱藏
            document.getElementById("loadingText").textContent = "離線模式啟動中...";
            overlay.style.opacity = "1"; // 確保 Loading 畫面清晰可見
            setTimeout(() => {
              overlay.style.display = "none";
              mainContent.style.display = "block";
            }, 3000);
          }
          mainContentShown = true;
        }
      }
      (function simulateLoadingPercentage() {
        const loadingText = document.getElementById("loadingText");
        let progress = 0;
        let lockedProgress = null;
        loadingTextInterval = setInterval(() => {
          if (!mainContentShown) {
            if (progress < 85) {
              progress++;
              loadingText.textContent = "載入中：" + progress + "%";
            } else {
              if (lockedProgress === null) {
                lockedProgress = 85 + Math.floor(Math.random() * 11);
              }
              loadingText.textContent = "載入中：" + lockedProgress + "%";
            }
          } else {
            clearInterval(loadingTextInterval);
          }
        }, 50);
      })();
      let youbikeDataCache = null; // 用於緩存 YouBike API 的資料

      async function searchYouBike(showLoadingIndicator = true) {
        if (showLoadingIndicator) showLoading();
        const keyword = keywordInput.value.trim().toLowerCase();
        try {
          // 新增離線模式判斷與快取讀取
          if (navigator.onLine) {
            if (!youbikeDataCache) {
              // 第一次載入時請求 YouBike API (使用您提供的 Python 腳本中的 API)
              const youbikeApiUrl = "https://apis.youbike.com.tw/json/station-min-yb2.json";
              const youbikeResponse = await fetch(youbikeApiUrl, {
                headers: {
                  'accept': '*/*',
                  'accept-language': 'zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-CN;q=0.6',
                  // 注意：Origin 和 Referer 在前端直接設置可能受限，通常由瀏覽器自動處理。
                  // 'origin': 'https://www.youbike.com.tw', // 如果需要，請取消註解並修改
                  // 'referer': 'https://www.youbike.com.tw/', // 如果需要，請取消註解並修改
                  'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36', // 可選的 user-agent
                }
              });
              if (!youbikeResponse.ok) throw new Error(`HTTP error! status: ${youbikeResponse.status}`);
              const youbikeData = await youbikeResponse.json();

              // ***** 這裡需要根據 youbikeData 的實際結構來取得站點資料陣列 *****
              // 假設 youbikeData 直接是一個站點物件的陣列，例如: [{ sno: "...", sna: "...", ... }, ...]
              // 如果資料被包裹在其他屬性中，例如 youbikeData.data.stations，請修改下方這行
              youbikeDataCache = youbikeData || [];

              // 將取得的資料儲存至 localStorage
              localStorage.setItem('cachedYouBikeData', JSON.stringify(youbikeDataCache)); // 更改 localStorage 的 key 名稱
            }
          } else {
            // 從 localStorage 讀取之前儲存的 YouBike API 資料
            if (!youbikeDataCache) {
              youbikeDataCache = JSON.parse(localStorage.getItem('cachedYouBikeData') || '[]'); // 更改 localStorage 的 key 名稱
            }
          }

          let filteredStations = youbikeDataCache; // 更改變數名以反映是 YouBike 資料

          if (keyword) {
            filteredStations = filteredStations.filter(station => {
              // ***** 請根據新的 API 資料結構調整屬性名稱 (例如 sno, sna, ar) *****
              const stationName = station.sna ? station.sna.toLowerCase() : ''; // 假設站點名稱屬性是 sna
              const stationAddress = station.ar ? station.ar.toLowerCase() : ''; // 假設站點地址屬性是 ar
              return stationName.includes(keyword) || stationAddress.includes(keyword);
            });
          }

          // 按距離排序 (如果使用定位)
          filteredStations.sort((a, b) => {
            // ***** 請根據新的 API 資料結構調整座標屬性名稱 (lat, lng) *****
            const distA = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              a.lat, b.lat // 假設緯度屬性是 lat
            );
            const distB = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              b.lat, b.lng // 假設經度屬性是 lng
            );
            return distA - distB;
          });

          let limit = keyword ? 50 : 20;
          let usedStations;

          // 處理釘選和非釘選站點的邏輯 (保持原有的排序和篩選邏輯，但使用新的站點資料)
          if (!keyword) {
            // ***** 請根據新的 API 資料結構調整站點 ID 屬性名稱 (sno) *****
            const pinnedFromLocal = filteredStations.filter(station => pinnedStations.has(String(station.sno))); // 假設站點 ID 屬性是 sno
            const unpinned = filteredStations.filter(station => !pinnedStations.has(String(station.sno))); // 假設站點 ID 屬性是 sno

            pinnedFromLocal.sort((a, b) => {
              // ***** 請根據新的 API 資料結構調整座標屬性名稱 (lat, lng) *****
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              return distA - distB;
            });

            unpinned.sort((a, b) => {
              // ***** 請根據新的 API 資料結構調整座標屬性名稱 (lat, lng) *****
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedFromLocal, ...unpinned].slice(0, limit);
          } else {
            usedStations = filteredStations.slice(0, limit);
            const pinnedList = usedStations.filter(station => pinnedStations.has(String(station.sno))); // 假設站點 ID 屬性是 sno
            const nonPinnedList = usedStations.filter(station => !pinnedStations.has(String(station.sno))); // 假設站點 ID 屬性是 sno

            pinnedList.sort((a, b) => {
              // ***** 請根據新的 API 資料結構調整座標屬性名稱 (lat, lng) *****
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              return distA - distB;
            });
            nonPinnedList.sort((a, b) => {
              // ***** 請根據新的 API 資料結構調整座標屬性名稱 (lat, lng) *****
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng // 假設緯度屬性是 lat, 經度屬性是 lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedList, ...nonPinnedList];
          }

          // 獲取車輛實時數據 (如果您需要這個功能且 API 正常)
          const isOnline = navigator.onLine;
          let vehData = {};
          // ***** 請根據新的 API 資料結構調整站點 ID 屬性名稱 (sno) *****
          const stationIds = usedStations.map(station => String(station.sno)); // 假設站點 ID 屬性是 sno
          if (isOnline) {
            // 如果您需要實時車輛數據且 queryVehicleData 使用的 API 正常，保留這行
            vehData = await queryVehicleData(stationIds);
          }

          const organizedOutput = usedStations.map(site => {
            const info = {
              // ***** 在這裡根據新的 YouBike API 資料結構取得對應的值 *****
              id: String(site.sno), // 假設站點 ID 屬性是 sno
              name: site.sna, // 假設站點名稱屬性是 sna
              coords: [site.lat, site.lng], // 假設緯度屬性是 lat, 經度屬性是 lng
              district: site.sarea, // 假設區域屬性是 sarea
              address: site.ar // 假設地址屬性是 ar
            };
            const vehicle = isOnline ? (Object.entries(vehData).find(([key]) => key === info.id)?.[1] || {}) : {};
            return { station_info: info, vehicle_info: vehicle };
          });

          // 將下列重建 DOM 的邏輯改成更新已存在的 DOM
          // 原本的： resultsDiv.innerHTML = ''; ... 建立所有卡片 ...
          organizedOutput.forEach(item => {
            const station = item.station_info;
            const vehicle = item.vehicle_info;
            let card = document.querySelector(`.station[data-id="${station.id}"]`);
            const pinButtonHtml = `<span class="pin-button ${pinnedStations.has(station.id) ? 'pinned' : ''}" data-id="${station.id}" onclick="togglePinStation('${station.id}', event)">${pinnedStations.has(station.id) ? '★' : '☆'}</span>`;
            const distance = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              station.coords[0],
              station.coords[1]
            );
            const displayDistance = distance < 1 ? Math.round(distance * 1000) + " 公尺" : distance.toFixed(2) + " 公里";
            const vehicleInfoHtml = isOnline ? `
                        <p>YouBike 2.0: <span class="vehicle_yb2">${vehicle?.available_2_0 !== undefined ? vehicle.available_2_0 : '未知'}</span></p>
                        <p>YouBike 2.0E: <span class="vehicle_ybe">${vehicle?.available_e !== undefined ? vehicle.available_e : '未知'}</span></p>
                        <p>可停空位數: <span class="vehicle_empty">${vehicle?.empty_spaces !== undefined ? vehicle.empty_spaces : '未知'}</span></p>
                      ` : '';
            const cardContent = `
                        ${pinButtonHtml}
                        <h3>${station.name || '未知站點'}</h3>
                        <p class="distance">距離: ${displayDistance}</p>
                        <p>地址: ${station.address || '未知地址'}</p>
                        ${vehicleInfoHtml}
                    `;
            if (card) {
              // 更新已存在卡片
              card.innerHTML = cardContent;
              card.dataset.lat = station.coords[0];
              card.dataset.lng = station.coords[1];
              card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
            } else {
              // 建立新的卡片
              card = document.createElement('div');
              card.className = 'station';
              card.dataset.id = station.id;
              card.dataset.lat = station.coords[0];
              card.dataset.lng = station.coords[1];
              card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
              card.innerHTML = cardContent;
              card.addEventListener("click", () => {
                const lat = parseFloat(station.coords[0]), lng = parseFloat(station.coords[1]);
                if (!isNaN(lat) && !isNaN(lng)) {
                  // ***** 這裡的 Google Maps 連結可能需要調整，確保使用正確的座標格式 *****
                  window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank");
                } else {
                  showModal("站點座標無效，無法開啟地圖。");
                }
              });
              resultsDiv.appendChild(card);
            }
          });

          // 移除不再存在的卡片
          const validIds = organizedOutput.map(item => item.station_info.id);
          Array.from(resultsDiv.children).forEach(card => {
            if (!validIds.includes(card.dataset.id)) {
              resultsDiv.removeChild(card);
            }
          });

          updateResultsOrder();

          // 新增：等待一次事件迴圈，確保卡片 DOM 更新完成
          await new Promise(resolve => setTimeout(resolve, 0));

          dataLoaded = true; // 資料已載入完成
          if (showLoadingIndicator) {
            // 僅在手動觸發時顯示 mainContent，避免自動更新時捲動畫面
            showMainContent();
          }
        } catch (error) {
          console.error("Fetch error:", error);
          resultsDiv.innerHTML = `發生錯誤: 無法載入站點資料。請檢查網路連線或稍後再試。詳細錯誤: ${error.message}`; // 提供更友善的錯誤訊息
        } finally {
          if (showLoadingIndicator) hideLoading();
        }
      }

      // 這個函式似乎用於獲取實時車輛數據，API 地址和邏輯與您提供的 Python 腳本不同。
      // 如果您希望使用您提供的 Python 腳本中的 API 來獲取所有站點資訊，
      // 並且該 API 不包含實時車輛數據，您可能需要移除或修改這個函式。
      // 如果您需要結合兩個 API (一個獲取站點資訊，一個獲取實時車輛數據)，
      // 則需要確保這裡的 API 地址和處理邏輯正確。
      async function queryVehicleData(stationIds) {
        if (stationIds.length > 60) {
          stationIds = stationIds.slice(0, 60);
        }
        const batchSize = 20;
        const allVehicleData = {};
        // 請確認這個 API 地址 (https://apis.youbike.com.tw/tw2/parkingInfo) 是否正常工作
        // 如果需要修改 Headers，請在這裡調整
        const headers = {
          'Accept': '*/*',
          'Content-Type': 'application/json',
          'Origin': 'https://www.youbike.com.tw', // 請根據您的網站來源和 API 要求修改
          'Referer': 'https://www.youbike.com.tw/' // 請根據您的網站 Referer 和 API 要求修改
        };
        for (let i = 0; i < stationIds.length; i += batchSize) {
          const stationIdBatch = stationIds.slice(i, i + batchSize);
          const body = JSON.stringify({ station_no: stationIdBatch });
          try {
            const response = await fetch('https://apis.youbike.com.tw/tw2/parkingInfo', {
              method: 'POST',
              headers,
              body
            });
            const result = await response.json();
            if (result.retCode === 1 && result.retVal && result.retVal.data) {
              const dataArray = result.retVal.data;
              dataArray.forEach(item => {
                allVehicleData[item.station_no] = {
                  available_2_0: item.available_spaces_detail ? item.available_spaces_detail.yb2 : 0,
                  available_e: item.available_spaces_detail ? item.available_spaces_detail.eyb : 0,
                  empty_spaces: item.empty_spaces || 0
                };
              });
            } else {
              console.error("API 請求失敗:", result.retMsg);
            }
          } catch (e) {
            console.error(e);
          }
        }
        return allVehicleData;
      }

      function updateResultsOrder() {
        const cards = Array.from(document.querySelectorAll(".station"));
        cards.sort((a, b) => {
          const aPinned = pinnedStations.has(a.dataset.id);
          const bPinned = pinnedStations.has(b.dataset.id);
          if (aPinned && !bPinned) return -1;
          if (!aPinned && bPinned) return 1;
          const distanceA = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(a.dataset.lat),
            parseFloat(a.dataset.lng)
          );
          const distanceB = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(b.dataset.lat),
            parseFloat(b.dataset.lng)
          );
          return distanceA - distB;
        });
        cards.forEach(card => {
          resultsDiv.appendChild(card);
        });
      }
      function showLoading() {
        loadingDiv.classList.add('show');
      }
      function hideLoading() {
        loadingDiv.classList.remove('show');
      }
      function showModal(message) {
        modalText.textContent = message;
        overlay.classList.add('show');
        modal.classList.add('show');
      }
      function hideModal() {
        overlay.classList.remove('show');
        modal.classList.remove('show');
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
      async function handleGeolocationSuccess(position) {
        const wasDefault = !userLocation || (userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude);
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        if (wasDefault) {
          await searchYouBike();
          updateResultsOrder();
        } else {
          updateCardDistances();
        }
      }
      function handleGeolocationError(error) {
        console.error("Geolocation error:", error);
        locationDenied = true;
        let errorMessage = "";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = "未提供定位權限，將使用捷運美麗島站作為中心定位。";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = "定位資訊不可用，將使用捷運美麗島站作為中心定位直到定位成功。";
            break;
          case error.TIMEOUT:
            errorMessage = "定位逾時，將使用捷運美麗島站作為中心定位直到定位成功。";
            break;
          default:
            errorMessage = "定位錯誤，將使用捷運美麗島站作為中心定位直到定位成功。";
            break;
        }
        showModal(errorMessage);
        userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
        searchYouBike();
      }
      function handleGeoUpdateSuccess(position) {
        const wasDefault = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        if (wasDefault) {
          searchYouBike().then(() => {
            updateResultsOrder();
          });
        } else {
          updateCardDistances();
        }
      }
      function handleGeoUpdateError(error) {
        console.error("Geolocation update error:", error);
      }
      function getLocation() {
        if (!document.getElementById('toggleUseLocation').checked) {
          return;
        }
        if (navigator.geolocation) {
          // 獲取一次性定位
          navigator.geolocation.getCurrentPosition(
            handleGeolocationSuccess,
            handleGeolocationError,
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 60000
            }
          );
          // 設置持續監聽定位變化
          navigator.geolocation.watchPosition(
            handleGeoUpdateSuccess,
            handleGeoUpdateError,
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        } else {
          handleGeolocationError({ code: 0, message: "瀏覽器不支援地理位置功能。" });
        }
      }

      function updateCardDistances() {
        if (!userLocation) return;
        const cards = document.querySelectorAll(".station");
        cards.forEach(card => {
          const stationLat = parseFloat(card.dataset.lat);
          const stationLng = parseFloat(card.dataset.lng);
          if (!isNaN(stationLat) && !isNaN(stationLng)) {
            const distance = calculateDistance(userLocation.latitude, userLocation.longitude, stationLat, stationLng);
            const displayDistance = distance < 1 ? Math.round(distance * 1000) + " 公尺" : distance.toFixed(2) + " 公里";
            const distanceElement = card.querySelector(".distance");
            if (distanceElement) {
              distanceElement.textContent = `距離: ${displayDistance}`;
            }
          }
        });
      }

      // 初始化載入
      document.addEventListener('DOMContentLoaded', async () => {
        // 確保先顯示載入畫面
        document.getElementById("loadingOverlay").style.display = "flex";
        document.getElementById("loadingOverlay").style.opacity = "1";

        // 檢查是否有快取的 YouBike 資料
        const cachedData = localStorage.getItem('cachedYouBikeData');
        if (cachedData) {
          try {
            youbikeDataCache = JSON.parse(cachedData);
            dataLoaded = true;
            console.log("從快取載入站點資料");
          } catch (e) {
            console.error("解析快取資料失敗:", e);
            youbikeDataCache = null;
          }
        }

        if (youbikeDataCache && youbikeDataCache.length > 0) {
          // 如果有快取資料，先顯示快取的資料
          console.log("顯示快取站點資料");
          // 重新渲染站點列表
          // 這裡需要呼叫一個函式來根據 youbikeDataCache 渲染列表
          // 暫時先呼叫 searchYouBike()，它會使用 youbikeDataCache
          await searchYouBike(false); // 不顯示重複的 loading

          // 在背景更新資料
          if (navigator.onLine) {
            console.log("背景更新站點資料");
            await searchYouBike(false); // 不顯示 loading，只更新資料和顯示
          } else {
            document.getElementById("loadingText").textContent = "離線模式啟動中...";
          }
          showMainContent(); // 顯示主要內容
        } else {
          // 如果沒有快取資料，或者快取資料無效，則從 API 獲取
          console.log("從 API 載入站點資料");
          await searchYouBike(true); // 顯示 loading
        }

        // 獲取用戶定位 (如果啟用)
        if (useLocation) {
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          // 如果沒有使用定位，並且站點資料已經載入，則根據預設位置排序和顯示
          if (dataLoaded) {
            updateResultsOrder();
            updateCardDistances(); // 更新卡片上的距離顯示
            showMainContent();
          }
        }

        // 每隔一段時間更新車輛數據 (如果 API 正常)
        setInterval(updateVehicleData, 30000); // 每 30 秒更新一次

        // 其他事件監聽器
        modalButton.addEventListener('click', hideModal);
        keywordInput.addEventListener('input', searchYouBike); // 當輸入框內容改變時觸發搜尋
        document.getElementById('searchIcon').addEventListener('click', searchYouBike); // 點擊搜尋圖示觸發搜尋

        // 暗色模式切換
        const toggleDarkModeButton = document.getElementById('toggleDarkMode');
        const currentMode = localStorage.getItem('darkMode');
        if (currentMode === 'enabled') {
          document.body.classList.add('dark-mode');
        }
        toggleDarkModeButton.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('darkMode', 'enabled');
          } else {
            localStorage.setItem('darkMode', 'disabled');
          }
        });

        // 安裝 PWA 按鈕
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        window.addEventListener('beforeinstallprompt', (e) => {
          // Prevent the mini-infobar from appearing on mobile
          e.preventDefault();
          // Stash the event so it can be triggered later.
          deferredPrompt = e;
          // Update UI notify the user they can install the PWA
          installButton.style.display = 'flex';
        });

        installButton.addEventListener('click', async () => {
          // Hide the install button
          installButton.style.display = 'none';
          // Show the install prompt
          if (deferredPrompt) {
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            const { outcome } = await deferredPrompt.userChoice;
            // Optionally, send analytics event with outcome of user choice
            console.log(`User response to the install prompt: ${outcome}`);
            // We've used the prompt, and can't use it again, throw it away
            deferredPrompt = null;
          }
        });

        window.addEventListener('appinstalled', () => {
          // Hide the install button
          installButton.style.display = 'none';
          // Clear the deferredPrompt so it can be garbage collected
          deferredPrompt = null;
          // Optionally, send analytics event to indicate successful install
          console.log('PWA was installed');
        });
      });

      // 每隔一段時間更新車輛數據的函式
      async function updateVehicleData() {
        // 確保有站點資料且在線
        if (!youbikeDataCache || youbikeDataCache.length === 0 || !navigator.onLine) {
          return;
        }

        try {
          // 獲取當前顯示的站點 ID
          const displayedStationIds = Array.from(document.querySelectorAll(".station")).map(card => card.dataset.id);

          // 呼叫獲取車輛數據的 API
          const vehData = await queryVehicleData(displayedStationIds);

          // 更新頁面上的車輛數據顯示
          displayedStationIds.forEach(stationId => {
            const vehicleInfo = vehData[stationId];
            if (vehicleInfo) {
              const card = document.querySelector(`.station[data-id="${stationId}"]`);
              if (card) {
                const yb2Element = card.querySelector('.vehicle_yb2');
                const ybeElement = card.querySelector('.vehicle_ybe');
                const emptyElement = card.querySelector('.vehicle_empty');

                if (yb2Element) yb2Element.textContent = vehicleInfo.available_2_0 !== undefined ? vehicleInfo.available_2_0 : '未知';
                if (ybeElement) ybeElement.textContent = vehicleInfo.available_e !== undefined ? vehicleInfo.available_e : '未知';
                if (emptyElement) emptyElement.textContent = vehicleInfo.empty_spaces !== undefined ? vehicleInfo.empty_spaces : '未知';
              }
            }
          });
        } catch (error) {
          console.error("更新車輛數據失敗:", error);
        }
      }


    </script>
  </body>
</html>
