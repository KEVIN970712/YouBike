<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta name="google-site-verification" content="9o55RpXAKN7kR9cYHHvHkWuktV3JVcCYF5mt9XZULCY" />
    <meta charset="UTF-8" />
    <meta name="author" content="å“ç¨Ÿéˆ(AndrewCho)">
    <meta name="description" content="ä¸€å€‹å°ˆç‚º YouBike è¨­è¨ˆçš„ç°¡å–®ã€ç¾è§€ä¸”ä½æµé‡ç«™é»æœå°‹å™¨ï¼Œæä¾›å¿«é€ŸæŸ¥è©¢ç«™é»è³‡è¨ŠåŠŸèƒ½ï¼Œæ»¿è¶³å³æ™‚éœ€æ±‚ï¼Œé©åˆæ‰€æœ‰ç”¨æˆ¶ä½¿ç”¨ã€‚">    
    <meta name="keywords" content="YouBike, youBike, YouBike2.0, youBike2.0, ubike, ibike, obike, kbike, å¾®ç¬‘å–®è»Šï¼Œå…¬å…±è‡ªè¡Œè»Š, è…³è¸è»Šï¼ŒYouBikeç«™é»æœå°‹, ç«™é»æœå°‹, YouBike è³‡è¨Š, YouBikeæ“šé»ï¼Œubikeæ“šé» ï¼Œé™„è¿‘ç«™é», é™„è¿‘YouBikeç«™é», å…¨å°YouBike, å°åŒ—YouBike, æ–°åŒ—YouBike, æ¡ƒåœ’YouBike, æ–°ç«¹YouBike, è‹—æ —YouBike, è‡ºä¸­YouBike, å˜‰ç¾©YouBike , è‡ºå—YouBike, é«˜é›„YouBike, å±æ±YouBike, è‡ºæ±YouBike , YouBikeå³æ™‚è³‡è¨Š, å®šä½åŠŸèƒ½, Github, github.io" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouBike ç«™é»æœå°‹ : ä¸€å€‹ç°¡å–®ã€ç¾è§€ã€ä½æµé‡çš„YouBikeç«™é»æœå°‹å™¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="/YouBike/manifest.json" />
    <link rel="icon" type="image/x-icon" href="https://potatosserver.github.io/YouBike/icons/icon.ico" />
    <style>
      body {
        font-family: 'Noto Sans TC', Arial, sans-serif;
        margin: 20px;
        background: #f4f4f4;
        transition: background 0.5s ease, color 0.5s ease;
      }
      h1 {
        color: #007BFF;
        text-align: center;
        margin-bottom: 20px;
      }
      /* Material 3 é¢¨æ ¼çš„æœå°‹æ¬„å®¹å™¨ */
      #searchContainer {
        display: flex;
        align-items: center;
        margin-left: auto;
        margin-right: auto;
        max-width: 500px;
        width: 100%;
        position: relative;
        padding: 8px 16px; /* èª¿æ•´å…§éƒ¨é–“è·ï¼Œå·¦å³16px */
        box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒå¢åŠ ç¸½å¯¬åº¦ */
        background-color: white; /* Default background */
        border-radius: 28px; /* å¤§åœ“è§’ */
        /* ç§»é™¤é™°å½±æ•ˆæœ */
        transition: box-shadow 0.3s ease;
      }

      body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* Dark mode background */
          /* ç§»é™¤æš—è‰²æ¨¡å¼ä¸‹çš„é™°å½±æ•ˆæœ */
      }

      /* Material 3 é¢¨æ ¼çš„æœå°‹è¼¸å…¥æ¡† */
      #keyword {
        padding: 0 0 0 12px; /* èª¿æ•´ padding-left ç¢ºä¿æ–‡å­—ä¸æœƒè¢«é®è“‹ */
        flex-grow: 1; /* è®“è¼¸å…¥æ¡†ä½”æ“šå¯ç”¨ç©ºé–“ */
        border: none; /* ç§»é™¤é‚Šæ¡† */
        border-radius: 0; /* åœ“è§’ç”± container æ§åˆ¶ */
        margin: 0; /* ç§»é™¤ margin */
        font-size: 16px;
        box-shadow: none; /* é™°å½±ç”± container æ§åˆ¶ */
        word-wrap: break-word;
        overflow-wrap: break-word;
        display: block;
        background-color: transparent; /* é€æ˜èƒŒæ™¯ï¼Œé¡¯ç¤º container èƒŒæ™¯ */
        color: #333; /* Default text color */
      }

      body.dark-mode #keyword {
          color: #ffffff; /* Dark mode text color */
      }

      #keyword:focus {
        outline: none; /* ç§»é™¤é è¨­ focus æ¡† */
        /* é€™è£¡å¯ä»¥æ·»åŠ  Material 3 é¢¨æ ¼çš„ focus æ•ˆæœ */
      }

      /* æœå°‹ icon æ¨£å¼ (Material Icons) */
      #searchIcon {
        position: static; /* è®“ icon åœ¨ flex ä½ˆå±€ä¸­è‡ªç„¶æ’åˆ— */
        margin-left: 10px; /* èˆ‡ input ä¹‹é–“çš„é–“è· */
        font-size: 24px; /* Material Icons é è¨­å¤§å° */
        cursor: pointer;
        color: #555; /* Default icon color */
        transition: color 0.3s ease;
        flex-shrink: 0; /* é˜²æ­¢ icon ç¸®å° */
        /* Material Icons éœ€è¦é€™äº›æ¨£å¼ */
        display: inline-flex; /* ä½¿ç”¨ flex è®“ icon å±…ä¸­ */
        align-items: center;
        justify-content: center;
        width: 24px; /* è¨­ç½®å¯¬åº¦ */
        height: 24px; /* è¨­ç½®é«˜åº¦ */
      }

      body.dark-mode #searchIcon {
          color: #ccc; /* Dark mode icon color */
      }

      #searchIcon:hover {
        color: #007BFF; /* Hover color */
      }

      /* å®šä½åœ–ç¤ºæ¨£å¼ */
      #locationIcon {
          margin-left: 10px; /* èˆ‡æœå°‹åœ–ç¤ºçš„é–“è·ï¼Œèª¿æ•´ç‚ºèˆ‡ searchIcon ç›¸åŒ */
          font-size: 20px; /* èª¿æ•´åœ–ç¤ºå¤§å°ï¼Œå¾ 24px ç¸®å°åˆ° 20px */
          cursor: pointer;
          color: #555; /* é è¨­åœ–ç¤ºé¡è‰² */
          transition: color 0.3s ease;
          flex-shrink: 0; /* é˜²æ­¢ç¸®å° */
      }
      body.dark-mode #locationIcon {
          color: #ccc; /* æš—è‰²æ¨¡å¼åœ–ç¤ºé¡è‰² */
      }
      #locationIcon.active {
          color: #007BFF; /* å•Ÿç”¨æ™‚çš„é¡è‰² */
      }
      body.dark-mode #locationIcon.active {
          color: #90CAF9; /* æš—è‰²æ¨¡å¼å•Ÿç”¨æ™‚çš„é¡è‰² */
      }

      button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 0 5px 5px 0;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        margin-left: 0;
        width: auto;
        min-width: 50px;
        text-align: center;
        display: block;
      }

      button:hover {
        background-color: #0056b3;
      }
      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .station {
        background-color: white;
        border: 1px solid #e0e0e0;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: calc(33% - 20px);
        min-width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
        position: relative;
      }
      .station:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
      .station h3 {
        margin: 0 0 10px 0;
        color: #007BFF;
        font-size: 1.2em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding-right: 30px;
      }
      .station p {
        margin: 0 0 5px 0;
        color: #555;
        font-size: 1em;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .station .pin-button {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #007BFF;
        transition: transform 0.2s ease, color 0.2s ease;
        user-select: none;  /* é˜²æ­¢æ–‡å­—è¢«é¸å– */
      }
      .station .pin-button:hover {
        transform: scale(1.2);
        color: #0056b3;
      }
      .station .pin-button.pinned {
        color: #FFD700;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 1.2em;
        z-index: 10;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
        white-space: nowrap;  /* æ–°å¢: é¿å…æ–‡å­—æ›è¡Œ */
        width: auto;         /* æ–°å¢: å‹•æ…‹èª¿æ•´å¯¬åº¦ */
      }
      #loading.show {
        opacity: 1;
        display: block;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .overlay.show {
        display: block;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        display: none;
      }
      .modal.show {
        display: block;
      }
      .modal button {
        margin: 10px auto;
        display: block;
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .modal button:hover {
        background-color: #0056b3;
      }
      body.dark-mode {
        background: #333;
        color: #ffffff;
        transition: background 0.5s ease, color 0.5s ease;
      }
      body.dark-mode h1 {
        color: #90CAF9;
      }
      body.dark-mode #keyword {
        /* åœ¨ dark mode ä¸‹ï¼Œkeyword çš„èƒŒæ™¯æ‡‰è©²æ˜¯é€æ˜çš„ï¼Œé€™æ¨£ searchContainer çš„èƒŒæ™¯æ‰èƒ½é¡¯ç¤º */
        background-color: transparent;
        color: #ffffff;
        border-color: #90caf9; /* é€™å€‹ border-color å…¶å¯¦ä¸æœƒé¡¯ç¤ºï¼Œå› ç‚º border: none */
      }
      body.dark-mode #keyword:focus {
         /* æš—è‰²æ¨¡å¼ä¸‹çš„ focus æ•ˆæœ */
      }
       body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* Dark mode container background */
          /* ç§»é™¤æš—è‰²æ¨¡å¼ä¸‹çš„é™°å½±æ•ˆæœ */
      }
       body.dark-mode #searchIcon {
          color: #ccc; /* Dark mode icon color */
      }
      body.dark-mode button {
        background-color: #90caf9;
        color: #121212;
      }
      body.dark-mode button:hover {
        background-color: #64b5f6;
      }
      body.dark-mode .station {
        background-color: #444;
        border-color: #555;
        color: #ffffff;
      }
      body.dark-mode .station h3 {
        color: #90CAF9;
      }
      body.dark-mode .station p {
        color: #cccccc;
      }
      body.dark-mode .modal {
        background-color: #333;
        color: #ffffff;
      }
      body.dark-mode .overlay {
        background-color: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode #loading {
        background: #ffffff;
        color: #000000;
      }
      body.dark-mode #loadingOverlay {
        background-color: rgba(51, 51, 51, 0.9);
      }
      body.dark-mode #loadingText {
        /* ä¿®æ­£è¼‰å…¥æ–‡å­—åœ¨æš—è‰²æ¨¡å¼ä¸‹çš„é¡è‰² */
        color: #90CAF9; 
        background: none; /* ç§»é™¤ä¸å¿…è¦çš„èƒŒæ™¯è¨­å®š */
      }
      body.dark-mode #noticeBox {
        background-color: #000;
        color: #000;
        border: 1px solid #444;
      }
      
      /* Styles for the combined floating menu options */
      #floatingMenuOptions {
          position: fixed;
          bottom: 120px; /* Position above the main toggle button */
          right: 20px;
          display: flex;
          flex-direction: column; /* Vertical alignment */
          gap: 10px; /* Space between buttons */
          z-index: 1000;
          opacity: 0; /* Hidden by default */
          visibility: hidden; /* Hidden by default */
          transition: opacity 0.3s ease, visibility 0.3s ease; /* Smooth fade in/out */
      }
      #floatingMenuOptions.show {
          opacity: 1;
          visibility: visible;
      }
      #floatingMenuOptions a,
      #floatingMenuOptions button {
          width: 50px;
          height: 50px;
          background-color: white;
          color: black;
          border: none;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          text-decoration: none;
          transition: background-color 0.3s ease, transform 0.2s ease;
      }
      #floatingMenuOptions a:hover,
      #floatingMenuOptions button:hover {
          background-color: #f0f0f0;
          transform: scale(1.1);
      }

      /* Specific styles for dark mode toggle and language toggle within the combined menu */
      #darkModeToggle, #langToggle {
          background: linear-gradient(135deg, #007BFF, #0056b3);
          color: white;
          font-size: 24px;
      }
      #darkModeToggle:hover, #langToggle:hover {
          background: linear-gradient(135deg, #0056b3, #003f7f);
      }
      body.dark-mode #darkModeToggle, body.dark-mode #langToggle {
        background: linear-gradient(135deg, #90caf9, #64b5f6);
        color: #121212;
      }
      body.dark-mode #darkModeToggle:hover, body.dark-mode #langToggle:hover {
        background: linear-gradient(135deg, #64b5f6, #42a5f5);
      }

      /* Main toggle button (gear icon) */
      #mainToggleButton {
        position: fixed;
        bottom: 60px; /* Position above update countdown */
        right: 20px;
        z-index: 1200; /* Ensure it's on top */
        width: 50px;
        height: 50px;
        background: white;
        color: black;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
      }
      #mainToggleButton:hover {
        transform: scale(1.1);
      }

      #updateCountdown {
          white-space: nowrap;
      }

      /* é‡å°çª„è¢å¹•çš„èª¿æ•´ */
      @media (max-width: 768px) {
        .station {
          width: calc(50% - 20px);
        }
        /* Adjusted search container for horizontal layout */
        #searchContainer {
            padding: 8px 16px; /* èª¿æ•´ paddingï¼Œå·¦å³16px */
        }
        #keyword {
          /* Adjusted width to leave space for the icon and toggle */
          flex-grow: 1; /* Allow keyword to grow */
          margin-right: 0;
          margin-bottom: 0; /* No margin-bottom in row layout */
          border-radius: 28px; /* Keep rounded corners like default */
          display: block;
          padding: 0 0 0 12px; /* èª¿æ•´ padding-left ç¢ºä¿æ–‡å­—ä¸æœƒè¢«é®è“‹ */
        }
         #searchIcon {
             position: static; /* Remain in static flow within flex container */
             margin-left: 10px; /* Space between input and icon */
             margin-top: 0; /* No margin-top in row layout */
             align-self: auto; /* Default alignment in flex row */
             font-size: 24px; /* Material Icons size */
             width: 24px;
             height: 24px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }
        /* å®šä½åœ–ç¤ºåœ¨çª„è¢å¹•ä¸‹çš„æ¨£å¼ */
        #locationIcon {
            margin-left: 10px; /* èª¿æ•´é–“è· */
            padding-right: 0; /* ç§»é™¤å³å´å…§é‚Šè· */
        }

        button {
          width: 100%;
          border-radius: 0 0 5px 5px;
          display: block;
        }

        #results {
          gap: 10px;
        }
        .station {
          margin-bottom: 10px;
        }
      }
      @media (max-width: 480px) {
        .station {
          width: 100%;
        }
        #searchContainer {
             padding: 10px 16px; /* æ›´å°çš„è¢å¹•é–“è·ï¼Œå·¦å³ä¿æŒ16px */
         }
         #keyword {
             /* Adjusted width for smaller screens if needed, keeping room for icon and toggle */
             flex-grow: 1; /* Allow keyword to grow */
             padding: 0 0 0 12px; /* èª¿æ•´ padding-left ç¢ºä¿æ–‡å­—ä¸æœƒè¢«é®è“‹ */
         }
          #searchIcon {
             /* Icon styles remain consistent with 768px breakpoint */
         }
      }
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
      }
      #loadingContent {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #loadingText {
        font-size: 1.5em;
        color: #007BFF;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="loadingOverlay">
      <div id="loadingContent">
        <h2 id="loadingText">è¼‰å…¥ä¸­</h2>
        </div>
    </div>
    <div id="mainContent" style="display:none;">
      <h1 id="heading"></h1>
      <div id="searchContainer">
        <input type="text" id="keyword" placeholder="è«‹è¼¸å…¥ç«™é»åç¨±ã€åœ°å€" value="" />
        <span id="searchIcon" class="material-icons" title="æœå°‹">search</span>
        <span id="locationIcon" class="material-icons" title="ä½¿ç”¨å®šä½">my_location</span>
      </div>
      <div id="results"></div>
      <div id="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
      <div class="overlay"></div>
      <div class="modal" id="permissionModal">
        <p id="modalText"></p>
        <button id="modalButton">ç¢ºå®š</button>
      </div>
      
      <div id="floatingMenuOptions">
          <a href="https://github.com/potatosserver/YouBike" target="_blank" title="YouBike Repo">
              <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/html.webp" alt="YouBike Repo" style="width:30px; height:30px;" />
          </a>
          <a href="https://github.com/potatosserver/YouBike_Python" target="_blank" title="YouBike Python">
                <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/python.webp" alt="YouBike Python" style="width:30px; height:30px;" />
          </a>
          <button id="darkModeToggle" title="åˆ‡æ›æš—è‰²æ¨¡å¼">ğŸŒ™</button>
          <button id="langToggle" title="Switch Language">
            <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/translate.webp" alt="Translate" style="width:35px; height:35px;" />
          </button>
      </div>

      <button id="mainToggleButton" title="è¨­å®š" style="position: fixed; bottom: 60px; right: 20px; z-index: 1200; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); transition: transform 0.2s ease;">âš™ï¸</button>
    </div>
    <button id="updateCountdown" style="display:none; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 6px 12px; background-color: white; color: #007bff; border: 2px solid #007bff; border-radius: 25px; font-size: 0.8em; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: all 0.3s ease; width: 100px;">60ç§’å¾Œæ›´æ–°</button>
    <script>
      let userLocation = null;
      let sortingLocked = false;
      let initialLoad = true;
      let locationDenied = false;
      let geolocationErrorMessage = null;
      let dataLoaded = false;
      const defaultLatitude = 22.6315725;
      const defaultLongitude = 120.3025079;
      const overlay = document.querySelector('.overlay');
      const modal = document.querySelector('.modal');
      const modalText = document.getElementById('modalText');
      const modalButton = document.getElementById('modalButton');
      const resultsDiv = document.getElementById('results');
      const loadingDiv = document.getElementById('loading');
      const keywordInput = document.getElementById('keyword');
      const maxResults = 100;
      const defaultSearchArea = "";
      const pinnedStations = new Set(JSON.parse(localStorage.getItem('pinnedStations') || '[]').map(id => String(id)));
      // ç›´æ¥å¾ localStorage è®€å– useLocation ç‹€æ…‹
      let useLocation = localStorage.getItem("useLocation") === "true"; 
      
      // ç²å–å®šä½åœ–ç¤ºå…ƒç´ 
      const locationIcon = document.getElementById('locationIcon');

      // åˆå§‹åŒ–å®šä½åœ–ç¤ºçš„ active ç‹€æ…‹
      if (useLocation) {
        locationIcon.classList.add('active');
      } else {
        locationIcon.classList.remove('active');
      }

      // é»æ“Šå®šä½åœ–ç¤ºåˆ‡æ›å®šä½åŠŸèƒ½
      locationIcon.addEventListener('click', () => {
        useLocation = !useLocation; // åˆ‡æ›ç‹€æ…‹
        localStorage.setItem("useLocation", useLocation); // æ›´æ–° localStorage

        if (useLocation) {
          locationIcon.classList.add('active');
          sortingLocked = true;
          getLocation();
        } else {
          locationIcon.classList.remove('active');
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
          updateVehicleData();
          setTimeout(updateResultsOrder, 1500);
        }
      });

      function togglePinStation(stationId, event) {
        event.stopPropagation();

        // çµ±ä¸€è½‰æ›ç‚ºå­—ä¸²é¡å‹
        const id = String(stationId);

        // æ›´æ–° pinnedStations Set
        if (pinnedStations.has(id)) {
          pinnedStations.delete(id);
        } else {
          pinnedStations.add(id);
        }

        // ç«‹å³æ›´æ–° localStorage
        try {
          localStorage.setItem('pinnedStations', JSON.stringify([...pinnedStations]));
        } catch (e) {
          console.error('Failed to save pinned stations:', e);
        }

        // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
        const pinButton = document.querySelector(`.pin-button[data-id="${id}"]`);
        if (pinButton) {
          const isPinned = pinnedStations.has(id);
          pinButton.classList.toggle('pinned', isPinned);
          pinButton.textContent = isPinned ? 'â˜…' : 'â˜†';
        }

        // é‡æ–°æ’åºçµæœ
        updateResultsOrder();
      }
      let mainContentShown = false;
      function showMainContent() {
        if (!mainContentShown) {
          const overlay = document.getElementById("loadingOverlay");
          const mainContent = document.getElementById("mainContent");
          if (navigator.onLine) {
            overlay.style.opacity = "0";
            setTimeout(() => {
              overlay.style.display = "none";
              mainContent.style.display = "block";
              document.getElementById('updateCountdown').style.display = "block";
            }, 500);
          } else {
            const lang = localStorage.getItem("lang") || "zh";
            document.getElementById("loadingText").textContent = lang === "en" ? "Offline mode starting..." : "é›¢ç·šæ¨¡å¼å•Ÿå‹•ä¸­...";
            overlay.style.opacity = "1";
            setTimeout(() => {
              overlay.style.display = "none";
              mainContent.style.display = "block";
              document.getElementById('updateCountdown').style.display = "block";
            }, 3000);
          }
          mainContentShown = true;
        }
      }
      (function simulateLoadingPercentage() {
        const loadingText = document.getElementById("loadingText");
        let lang = localStorage.getItem("lang") || "zh";
        let prefix = lang === "en" ? "Loading:" : "è¼‰å…¥ä¸­ï¼š";
        let progress = 0;
        let lockedProgress = null;
        loadingTextInterval = setInterval(() => {
          if (!mainContentShown) {
            if (progress < 85) {
              progress++;
              loadingText.textContent = prefix + progress + "%";
            } else {
              if (lockedProgress === null) {
                lockedProgress = 85 + Math.floor(Math.random() * 11);
              }
              loadingText.textContent = prefix + lockedProgress + "%";
            }
          } else {
            clearInterval(loadingTextInterval);
          }
        }, 50);
      })();

      let youbikeDataCache = null;

      async function searchYouBike(showLoadingIndicator = true) {
        if (showLoadingIndicator) showLoading();
        const keyword = keywordInput.value.trim().toLowerCase();
        try {
          if (navigator.onLine) {
            if (!youbikeDataCache) {
              const youbikeUrl = "https://apis.youbike.com.tw/json/station-min-yb2.json";
              const response = await fetch(youbikeUrl, {
                headers : {
                  'accept': '*/*',
                  'accept-language': 'zh-TW,zh;q=0.9',
                }
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              const youbikeData = await response.json();
              youbikeDataCache = Array.isArray(youbikeData)
                ? youbikeData.map(item => ({ ...item, lat: parseFloat(item.lat), lng: parseFloat(item.lng) }))
                : [];
              localStorage.setItem('cachedYoubikeData', JSON.stringify(youbikeDataCache));
            }
          } else {
            if (!youbikeDataCache) {
              youbikeDataCache = JSON.parse(localStorage.getItem('cachedYoubikeData') || '[]').map(item => ({
                ...item,
                lat: parseFloat(item.lat),
                lng: parseFloat(item.lng)
              }));
            }
          }
          let youbikeResults = youbikeDataCache;
          if (keyword) {
            youbikeResults = youbikeResults.filter(station => {
              const stationNameTW = station.name_tw ? station.name_tw.toLowerCase() : '';
              const stationAddressTW = station.address_tw ? station.address_tw.toLowerCase() : '';
              const stationNameEN = station.name_en ? station.name_en.toLowerCase() : '';
              const stationAddressEN = station.address_en ? station.address_en.toLowerCase() : '';
              return stationNameTW.includes(keyword) || stationAddressTW.includes(keyword) ||
                     stationNameEN.includes(keyword) || stationAddressEN.includes(keyword);
            });
          }
          youbikeResults = youbikeResults.sort((a, b) => {
            const distA = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              a.lat, a.lng
            );
            const distB = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              b.lat, b.lng
            );
            return distA - distB;
          });
          let limit = keyword ? 50 : 20;
          let usedStations;
          if (!keyword) {
            const pinnedFromLocal = youbikeResults.filter(station => pinnedStations.has(String(station.station_no)));
            const unpinned = youbikeResults.filter(station => !pinnedStations.has(String(station.station_no)));
            pinnedFromLocal.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            unpinned.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedFromLocal, ...unpinned].slice(0, limit);
          } else {
            usedStations = youbikeResults.slice(0, limit);
            const pinnedList = usedStations.filter(station => pinnedStations.has(String(station.station_no)));
            const nonPinnedList = usedStations.filter(station => !pinnedStations.has(String(station.station_no)));
            pinnedList.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            nonPinnedList.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedList, ...nonPinnedList];
          }
          const isOnline = navigator.onLine;
          let vehData = {};
          const stationIds = usedStations.map(station => String(station.station_no));
          if (isOnline) {
            vehData = await queryVehicleData(stationIds);
          }
          // ä¿®æ”¹ç«™é»è³‡è¨Šä¾èªè¨€åˆ‡æ›: è‹¥ç‚ºè‹±æ–‡å‰‡å–è‹±æ–‡å±¬æ€§
          const organizedOutput = usedStations.map(site => {
            const info = {
              id: String(site.station_no),
              name: currentLang === "en" ? site.name_en : site.name_tw,
              coords: [site.lat, site.lng],
              district: currentLang === "en" ? site.district_en : site.district_tw,
              address: currentLang === "en" ? site.address_en : site.address_tw
            };
            const vehicle = isOnline ? (Object.entries(vehData).find(([key]) => key === info.id)?.[1] || {}) : {};
            return { station_info: info, vehicle_info: vehicle };
          });
          organizedOutput.forEach(item => {
            const station = item.station_info;
            const vehicle = item.vehicle_info;
            let card = document.querySelector(`.station[data-id="${station.id}"]`);

            // ç¢ºä¿é‡˜é¸ç‹€æ…‹åˆ¤æ–·ä¸€è‡´
            const isPinned = pinnedStations.has(String(station.id));
            const pinButtonHtml = `<span
              class="pin-button ${isPinned ? 'pinned' : ''}"
              data-id="${station.id}"
              onclick="togglePinStation('${station.id}', event)"
            >${isPinned ? 'â˜…' : 'â˜†'}</span>`;
            const distance = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              station.coords[0],
              station.coords[1]
            );
            const displayDistance = distance < 1 ? Math.round(distance * 1000) + (currentLang === "en" ? " m" : " å…¬å°º")
                                                 : distance.toFixed(2) + (currentLang === "en" ? " km" : " å…¬é‡Œ");
            const distanceLabel = currentLang === "en" ? "Distance:" : "è·é›¢:";
            const addressLabel = currentLang === "en" ? "Address:" : "åœ°å€:";
            const slotsLabel = currentLang === "en" ? "Available Slots:" : "å¯åœç©ºä½æ•¸ï¼š";
            const unknownStation = currentLang === "en" ? "Unknown Station" : "æœªçŸ¥ç«™é»";
            const unknownAddress = currentLang === "en" ? "Unknown Address" : "æœªçŸ¥åœ°å€";
            const unknownValue = currentLang === "en" ? "Unknown" : "æœªçŸ¥";
            const vehicleInfoHtml = isOnline ? `
                          <p>YouBike 2.0ï¼š <span class="vehicle_yb2">${vehicle?.available_2_0 !== undefined ? vehicle.available_2_0 : unknownValue}</span></p>
                          <p>YouBike 2.0Eï¼š <span class="vehicle_ybe">${vehicle?.available_e !== undefined ? vehicle.available_e : unknownValue}</span></p>
                          <p>${slotsLabel} <span class="vehicle_empty">${vehicle?.empty_spaces !== undefined ? vehicle.empty_spaces : unknownValue}</span></p>
                        ` : '';
            // ç•¶ä½¿ç”¨é è¨­åº§æ¨™æ™‚ä¸é¡¯ç¤ºè·é›¢
            const isDefaultLocation = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
            const distanceHTML = !isDefaultLocation ? `<p class="distance">${distanceLabel} ${displayDistance}</p>` : "";
            const cardContent = `
                          ${pinButtonHtml}
                          <h3>${station.name || unknownStation}</h3>
                          ${distanceHTML}
                          <p>${addressLabel} ${station.address || unknownAddress}</p>
                          ${vehicleInfoHtml}
                      `;
            if (card) {
              card.innerHTML = cardContent;
              card.dataset.lat = station.coords[0];
              card.dataset.lng = station.coords[1];
              card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
            } else {
              card = document.createElement('div');
              card.className = 'station';
              card.dataset.id = station.id;
              card.dataset.lat = station.coords[0];
              card.dataset.lng = station.coords[1];
              card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
              card.innerHTML = cardContent;
              resultsDiv.appendChild(card);
            }
          });
          const validIds = organizedOutput.map(item => item.station_info.id);
          Array.from(resultsDiv.children).forEach(card => {
            if (!validIds.includes(card.dataset.id)) {
              resultsDiv.removeChild(card);
            }
          });
          updateResultsOrder();
          await new Promise(resolve => setTimeout(resolve, 0));

          dataLoaded = true;
          if (showLoadingIndicator) {
            showMainContent();
          }
        } catch (error) {
          console.error("Fetch error:", error);
          resultsDiv.innerHTML = `ç™¼ç”ŸéŒ¯èª¤: ${error.message}`;
        } finally {
          if (showLoadingIndicator) hideLoading();
        }
      }
      async function queryVehicleData(stationIds) {
        if (stationIds.length > 60) {
          stationIds = stationIds.slice(0, 60);
        }
        const batchSize = 20;
        const allVehicleData = {};
        const headers = {
          'Accept': '*/*',
          'Content-Type': 'application/json',
          'Origin': 'https://www.youbike.com.tw',
          'Referer': 'https://www.youbike.com.tw/'
        };
        for (let i = 0; i < stationIds.length; i += batchSize) {
          const stationIdBatch = stationIds.slice(i, i + batchSize);
          const body = JSON.stringify({ station_no: stationIdBatch });
          try {
            const response = await fetch('https://apis.youbike.com.tw/tw2/parkingInfo', {
              method: 'POST',
              headers,
              body
            });
            const result = await response.json();
            if (result.retCode === 1 && result.retVal && result.retVal.data) {
              const dataArray = result.retVal.data;
              dataArray.forEach(item => {
                allVehicleData[item.station_no] = {
                  available_2_0: item.available_spaces_detail ? item.available_spaces_detail.yb2 : 0,
                  available_e: item.available_spaces_detail ? item.available_spaces_detail.eyb : 0,
                  empty_spaces: item.empty_spaces || 0
                };
              });
            } else {
              console.error("API è«‹æ±‚å¤±æ•—:", result.retMsg);
            }
          } catch (e) {
            console.error(e);
          }
        }
        return allVehicleData;
      }
      function updateResultsOrder() {
        const cards = Array.from(document.querySelectorAll(".station"));
        cards.sort((a, b) => {
          const aPinned = pinnedStations.has(a.dataset.id);
          const bPinned = pinnedStations.has(b.dataset.id);
          if (aPinned && !bPinned) return -1;
          if (!aPinned && bPinned) return 1;
          const distanceA = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(a.dataset.lat),
            parseFloat(a.dataset.lng)
          );
          const distanceB = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(b.dataset.lat),
            parseFloat(b.dataset.lng)
          );
          return distanceA - distanceB;
        });
        cards.forEach(card => {
          resultsDiv.appendChild(card);
        });
      }
      function showLoading() {
        loadingDiv.classList.add('show');
      }
      function hideLoading() {
        loadingDiv.classList.remove('show');
      }
      function showModal(message) {
        modalText.textContent = message;
        overlay.classList.add('show');
        modal.classList.add('show');
      }
      function hideModal() {
        overlay.classList.remove('show');
        modal.classList.remove('show');
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }
      async function handleGeolocationSuccess(position) {
        const wasDefault = !userLocation || (userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude);
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        if (wasDefault) {
          await searchYouBike();
          updateResultsOrder();
        } else {
          updateCardDistances();
        }
      }
      function handleGeolocationError(error) {
        console.error("Geolocation error:", error);
        locationDenied = true;
        let errorMessage = "";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = currentLang === "en"
              ? "Location permission was denied; using default coordinates."
              : "æœªæä¾›å®šä½æ¬Šé™ï¼Œå°‡ä½¿ç”¨é è¨­åº§æ¨™é€²è¡Œå®šä½ã€‚";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = currentLang === "en"
              ? "Location information is unavailable; using default coordinates until the location is determined."
              : "å®šä½è³‡è¨Šä¸å¯ç”¨ï¼Œå°‡ä½¿ç”¨é è¨­åº§æ¨™é€²è¡Œå®šä½ç›´åˆ°å®šä½æˆåŠŸã€‚";
            break;
          case error.TIMEOUT:
            errorMessage = currentLang === "en"
              ? "The location request timed out; using default coordinates until a successful location is acquired."
              : "å®šä½é€¾æ™‚ï¼Œå°‡ä½¿ç”¨é è¨­åº§æ¨™é€²è¡Œå®šä½ç›´åˆ°å®šä½æˆåŠŸã€‚";
            break;
          default:
            errorMessage = currentLang === "en"
              ? "A location error occurred; using default coordinates until a valid location is determined."
              : "å®šä½éŒ¯èª¤ï¼Œå°‡ä½¿ç”¨é è¨­åº§æ¨™é€²è¡Œå®šä½ç›´åˆ°å®šä½æˆåŠŸã€‚";
            break;
        }
        showModal(errorMessage);
        userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
        searchYouBike();
      }
      function handleGeoUpdateSuccess(position) {
        const wasDefault = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        if (wasDefault) {
          searchYouBike().then(() => {
            updateResultsOrder();
          });
        } else {
          updateCardDistances();
        }
      }
      function handleGeoUpdateError(error) {
        console.error("Geolocation update error:", error);
      }
      function getLocation() {
        // æª¢æŸ¥ useLocation ç‹€æ…‹ï¼Œè€Œä¸æ˜¯é–‹é—œçš„ checked å±¬æ€§
        if (!useLocation) {
          return;
        }
        if (navigator.geolocation) {
          let timeoutTriggered = false;
          const geoTimeout = setTimeout(() => {
            timeoutTriggered = true;
            handleGeolocationError({ code: 3, message: "é¦–æ¬¡å®šä½è¶…æ™‚" });
          }, 10000);
          navigator.geolocation.getCurrentPosition(
            function (position) {
              if (!timeoutTriggered) {
                clearTimeout(geoTimeout);
                handleGeolocationSuccess(position);
              }
            },
            function (error) {
              if (!timeoutTriggered) {
                clearTimeout(geoTimeout);
                handleGeolocationError(error);
              }
            },
            {
              enableHighAccuracy: true,
              timeout: 10000, // æœ€å¤§ç­‰å¾…10ç§’
              maximumAge: 0
            }
          );
          setInterval(() => {
            // æª¢æŸ¥ useLocation ç‹€æ…‹ï¼Œè€Œä¸æ˜¯é–‹é—œçš„ checked å±¬æ€§
            if (useLocation) {
              navigator.geolocation.getCurrentPosition(
                handleGeoUpdateSuccess,
                handleGeoUpdateError,
                {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                }
              );
            }
          }, 10000);
        } else {
          showModal("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚ç«™é»å°‡ä»¥å°‡ä½¿ç”¨é è¨­åº§æ¨™é€²è¡Œå®šä½ã€‚");
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
          hideLoading();
        }
      }
      function updateCardDistances() {
        const cards = document.querySelectorAll('.station');
        cards.forEach(card => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          const newDistance = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            lat, lng
          );
          const distanceEl = card.querySelector('.distance');
          // ç•¶ä½¿ç”¨é è¨­åº§æ¨™æ™‚ï¼Œéš±è—è·é›¢é¡¯ç¤º
          if (distanceEl) {
            if (userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude) {
              distanceEl.textContent = "";
            } else {
              const distanceLabel = currentLang === "en" ? "Distance:" : "è·é›¢:";
              const unit = newDistance < 1 ? (currentLang === "en" ? " m" : " å…¬å°º") : (currentLang === "en" ? " km" : " å…¬é‡Œ");
              const displayDistance = newDistance < 1 ? Math.round(newDistance * 1000) : newDistance.toFixed(2);
              distanceEl.textContent = distanceLabel + " " + displayDistance + unit;
            }
          }
        });
        updateResultsOrder();
      }
      function updateVehicleData() {
        const stationElements = document.querySelectorAll('.station');
        if (!stationElements.length) return;
        const stationIds = Array.from(stationElements).map(el => el.dataset.id);
        queryVehicleData(stationIds)
          .then(vehicleData => {
            stationElements.forEach(card => {
              const id = card.dataset.id;
              const data = vehicleData[id] || {};
              const yb2El = card.querySelector('.vehicle_yb2');
              const ybeEl = card.querySelector('.vehicle_ybe');
              const emptyEl = card.querySelector('.vehicle_empty');
              if (yb2El) yb2El.textContent = (data.available_2_0 !== undefined ? data.available_2_0 : 'æœªçŸ¥');
              if (ybeEl) ybeEl.textContent = (data.available_e !== undefined ? data.available_e : 'æœªçŸ¥');
              if (emptyEl) emptyEl.textContent = (data.empty_spaces !== undefined ? data.empty_spaces : 'æœªçŸ¥');
            });
            updateResultsOrder();
          })
          .catch(error => {
            console.error("Vehicle data update failed:", error);
          });
      }
      // Dark mode toggle logic (now within floatingMenuOptions)
      const darkModeToggle = document.getElementById('darkModeToggle');
      darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("dark_mode", isDark);
        darkModeToggle.innerHTML = isDark ? '<span style="color:#ffd700; font-size:32px;">â˜€ï¸</span>' : 'ğŸŒ™';
      });
      if (localStorage.getItem("dark_mode") === "true") {
        document.body.classList.add("dark-mode");
        darkModeToggle.innerHTML = '<span style="color:#ffd700; font-size:32px;">â˜€ï¸';
      }

      // è¨­å®šç›®å‰èªè¨€ï¼Œé è¨­ç‚ºä¸­æ–‡
      let currentLang = localStorage.getItem("lang") || "zh";

      // æ›´æ–°é é¢ä¸Šæ‰€æœ‰èˆ‡å®šä½é–‹é—œç›¸é—œçš„æ–‡å­—ï¼Œç¢ºä¿è‹±æ–‡æ¨¡å¼ä¸‹ä¸é¡¯ç¤ºä¸­æ–‡
      function updateLanguageTexts() {
        document.title = currentLang === "en" ? "YouBike Site Search : A simple, beautiful site search engine" : "YouBike ç«™é»æœå°‹ : ä¸€å€‹ç°¡å–®ã€ç¾è§€ã€ä½æµé‡çš„YouBikeç«™é»æœå°‹å™¨";
        // å°‡å®šä½é–‹é—œçš„æ–‡å­—æ›¿æ›ç‚ºåœ–ç¤ºçš„ title å±¬æ€§
        const locationIcon = document.querySelector('#locationIcon');
        if (locationIcon) {
          locationIcon.title = currentLang === "en" ? "Use Location" : "ä½¿ç”¨å®šä½";
        }
        const heading = document.getElementById('heading');
        if (heading) {
            heading.textContent = currentLang === "en" ? "YouBike Station Search" : "YouBike ç«™é»æœå°‹";
        }
        const keywordInput = document.getElementById('keyword');
        if (keywordInput) {
          keywordInput.placeholder = currentLang === "en" ? "Please enter station name or address" : "è«‹è¼¸å…¥ç«™é»åç¨±ã€åœ°å€";
        }
        const updateCountdownBtn = document.getElementById('updateCountdown');
        if (updateCountdownBtn) {
          updateCountdownBtn.textContent = currentLang === "en" ? "60 sec update " : "60ç§’å¾Œæ›´æ–°";
        }
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
          loadingDiv.textContent = currentLang === "en" ? "Loading, please wait..." : "è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...";
        }
      }
      updateLanguageTexts();

      // èªè¨€åˆ‡æ›æŒ‰éˆ•äº‹ä»¶ï¼šç›´æ¥æ›´æ–°æ–‡å­—ï¼Œä¸å†é‡æ–°è¼‰å…¥é é¢
      const langToggle = document.getElementById('langToggle');
      langToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        currentLang = currentLang === "en" ? "zh" : "en";
        localStorage.setItem("lang", currentLang);
        updateLanguageTexts();
        // ç›´æ¥å‘¼å« searchYouBike æ›´æ–°ç«™é»å¡ç‰‡æ–‡å­—ï¼Œä¸é¡¯ç¤º loading æ•ˆæœ 
        searchYouBike(false);
      });

      const mainToggleButton = document.getElementById('mainToggleButton');
      const floatingMenuOptions = document.getElementById('floatingMenuOptions');

      mainToggleButton.addEventListener('click', (event) => {
        event.stopPropagation(); // Prevent document click from immediately closing
        floatingMenuOptions.classList.toggle('show');
      });

      // Close panels when clicking anywhere else on the document
      document.addEventListener('click', (event) => {
          // Check if the click target is outside the mainToggleButton and floatingMenuOptions
          if (!mainToggleButton.contains(event.target) && 
              !floatingMenuOptions.contains(event.target)) {
              floatingMenuOptions.classList.remove('show');
          }
      });

      // Prevent clicks inside the panels from closing them
      floatingMenuOptions.addEventListener('click', (event) => {
        event.stopPropagation();
      });

      modalButton.addEventListener('click', hideModal);
      window.addEventListener('load', () => {
        // æ ¹æ“š useLocation ç‹€æ…‹æ±ºå®šæ˜¯å¦å•Ÿç”¨å®šä½
        if (useLocation) {
          getLocation();
        } else {
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
          searchYouBike();
        }
      });
      keywordInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          searchYouBike();
        }
      });

    window.addEventListener('scroll', () => {
        // Close panels on scroll
        floatingMenuOptions.classList.remove('show');
    });

document.getElementById('heading').addEventListener('click', function() {
    keywordInput.value = '';
    countdownTimer.reset(); // é‡è¨­å€’æ•¸è¨ˆæ™‚
    searchYouBike();
});
const searchIcon = document.getElementById('searchIcon');
searchIcon.addEventListener('click', searchYouBike);
let countdownTimer = {
    remaining: 60,
    updateButton: document.getElementById('updateCountdown'),
    updateDisplay: function() {
        this.updateButton.textContent = currentLang === "en"
            ? `${this.remaining} sec update `
            : `${this.remaining}ç§’å¾Œæ›´æ–°`;
    },
    reset: function() {
        this.remaining = 60;
    }
};
countdownTimer.updateDisplay();
setInterval(() => {
    countdownTimer.remaining--;
    if (countdownTimer.remaining <= 0) {
        searchYouBike();
        countdownTimer.reset();
    }
    countdownTimer.updateDisplay();
}, 1000);
countdownTimer.updateButton.addEventListener('click', () => {
    searchYouBike();
    countdownTimer.reset();
    countdownTimer.updateDisplay();
});
    </script>
    <script defer>
      // Register Service Worker non-blocking
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
          navigator.serviceWorker
            .register("../YouBike/service-worker.js")
            .then(function (registration) {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(function (error) {
              console.error('Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
