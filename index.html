<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta name="google-site-verification" content="9o55RpXAKN7kR9cYHHvHkWuktV3JVcCYF5mt9XZULCY" />
    <meta charset="UTF-8" />
    <meta name="author" content="卓稟鈞(AndrewCho)">
    <meta name="description" content="一個專為 YouBike 設計的簡單、美觀且低流量站點搜尋器，提供快速查詢站點資訊功能，滿足即時需求，適合所有用戶使用。">
    <meta name="keywords" content="YouBike, youBike, YouBike2.0, youBike2.0, ubike, ibike, obike, kbike, 微笑單車，公共自行車, 腳踏車，YouBike站點搜尋, 站點搜尋, YouBike 資訊, YouBike據點，ubike據點 ，附近站點, 附近YouBike站點, 全台YouBike, 台北YouBike, 新北YouBike, 桃園YouBike, 新竹YouBike, 苗栗YouBike, 臺中YouBike, 嘉義YouBike , 臺南YouBike, 高雄YouBike, 屏東YouBike, 臺東YouBike , YouBike即時資訊, 定位功能, Github, github.io" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouBike 站點搜尋 : 一個簡單、美觀、低流量的YouBike站點搜尋器</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="manifest" href="/YouBike/manifest.json" />
    <link rel="icon" type="image/x-icon" href="https://potatosserver.github.io/YouBike/icons/icon.ico" />
    <style>
      body {
        font-family: 'Noto Sans TC', Arial, sans-serif;
        margin: 20px;
        background: #f4f4f4;
        transition: background 0.5s ease, color 0.5s ease;
      }
      h1 {
        color: #007BFF;
        text-align: center;
        margin-bottom: 20px;
      }
      /* Material 3 風格的搜尋欄容器 */
      #searchContainer {
        display: flex; /* 使用 flexbox 佈局 */
        align-items: center; /* 垂直居中對齊 */
        margin-left: auto;
        margin-right: auto;
        max-width: 500px;
        width: 100%;
        position: relative;
        /* 調整左右 padding 以為圖示留出空間 */
        padding: 8px 16px; /* 寬螢幕下的左右間距 */
        box-sizing: border-box;
        background-color: white; /* Default background */
        border-radius: 28px; /* 大圓角 */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* subtle elevation */
        transition: box-shadow 0.3s ease;
      }

      body.dark-mode #searchContainer {
          background-color: #1e1e1e; /* Dark mode background */
          box-shadow: 0 2px 4px rgba(255,255,255,0.1); /* Dark mode subtle elevation */
      }

      /* 搜尋圖示樣式 (Material Icons) */
      #searchIcon {
        /* 位置調整到左邊，並添加右側間距 */
        margin-left: 0; /* 移除左側間距 */
        margin-right: 10px; /* 與輸入框的間距 */
        font-size: 24px;
        cursor: pointer;
        color: #555; /* Default icon color */
        transition: color 0.3s ease;
        flex-shrink: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
      }

      body.dark-mode #searchIcon {
          color: #ccc; /* Dark mode icon color */
      }

      #searchIcon:hover {
        color: #007BFF; /* Hover color */
      }

      /* 定位圖示樣式 */
      #locationIcon {
        /* 位置調整到右邊，並添加左側間距 */
        margin-left: 10px; /* 與輸入框的間距 */
        margin-right: 0; /* 移除右側間距 */
        font-size: 24px; /* Material Icons 預設大小 */
        cursor: pointer;
        color: #555; /* 預設顏色 */
        transition: color 0.3s ease;
        flex-shrink: 0; /* 防止圖示縮小 */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
      }

      /* 定位功能開啟時的圖示顏色 */
      #locationIcon.active {
          color: #007BFF; /* 例如藍色，符合 Material Design 的強調色 */
      }

      body.dark-mode #locationIcon {
          color: #ccc; /* 暗色模式下的圖示顏色 */
      }

      body.dark-mode #locationIcon.active {
          color: #90CAF9; /* 暗色模式下開啟時的顏色 */
      }

      /* Material 3 風格的搜尋輸入框 */
      #keyword {
        padding: 0; /* 移除 input 自身的 padding */
        /* 調整寬度以考慮到左右兩側的圖示 */
        width: calc(100% - 24px - 10px - 24px - 10px); /* 減去左側搜尋圖示+間距，右側定位圖示+間距 */
        border: none;
        border-radius: 0;
        margin: 0;
        font-size: 16px;
        box-shadow: none;
        word-wrap: break-word;
        overflow-wrap: break-word;
        display: block;
        background-color: transparent;
        color: #333; /* Default text color */
        /* 為了讓文字不貼邊，在這裡或在媒體查詢中為 keyword 添加左右 padding */
         padding: 0 5px; /* 給予輸入框內部一些左右間距 */
      }

      body.dark-mode #keyword {
          color: #ffffff; /* Dark mode text color */
      }

      #keyword:focus {
        outline: none; /* 移除預設 focus 框 */
        /* 這裡可以添加 Material 3 風格的 focus 效果 */
      }

      /* 針對特定按鈕調整樣式 - 原定位開關相關樣式已移除 */


      button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px; /* 調整按鈕圓角 */
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        margin-left: 0;
        width: auto;
        min-width: 50px;
        text-align: center;
        display: block; /* 保持 block 顯示 */
      }


      button:hover {
        background-color: #0056b3;
      }
      #results {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
      }
      .station {
        background-color: white;
        border: 1px solid #e0e0e0;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: calc(33% - 20px);
        min-width: 250px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        word-wrap: break-word;
        overflow-wrap: break-word;
        position: relative;
      }
      .station:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
      }
      .station h3 {
        margin: 0 0 10px 0;
        color: #007BFF;
        font-size: 1.2em;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding-right: 30px;
      }
      .station p {
        margin: 0 0 5px 0;
        color: #555;
        font-size: 1em;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      .station .pin-button {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #007BFF;
        transition: transform 0.2s ease, color 0.2s ease;
        user-select: none;  /* 防止文字被選取 */
      }
      .station .pin-button:hover {
        transform: scale(1.2);
        color: #0056b3;
      }
      .station .pin-button.pinned {
        color: #FFD700;
      }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        font-size: 1.2em;
        z-index: 10;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
        white-space: nowrap;  /* 新增: 避免文字換行 */
        width: auto;         /* 新增: 動態調整寬度 */
      }
      #loading.show {
        opacity: 1;
        display: block;
      }
      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }
      .overlay.show {
        display: block;
      }
      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        display: none;
      }
      .modal.show {
        display: block;
      }
      .modal button {
        margin: 10px auto;
        display: block;
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
      }
      .modal button:hover {
        background-color: #0056b3;
      }
      body.dark-mode {
        background: #333;
        color: #ffffff;
        transition: background 0.5s ease, color 0.5s ease;
      }
      body.dark-mode h1 {
        color: #90CAF9;
      }
      body.dark-mode #keyword {
        background-color: transparent;
        color: #ffffff;
        border-color: #90caf9;
      }
      body.dark-mode #keyword:focus {
      }
       body.dark-mode #searchContainer {
          background-color: #1e1e1e;
          box-shadow: 0 2px 4px rgba(255,255,255,0.1);
      }
       body.dark-mode #searchIcon {
          color: #ccc;
      }
       body.dark-mode #locationIcon {
          color: #ccc;
      }
       body.dark-mode #locationIcon.active {
          color: #90CAF9;
      }
      body.dark-mode button {
        background-color: #90caf9;
        color: #121212;
      }
      body.dark-mode button:hover {
        background-color: #64b5f6;
      }
      body.dark-mode .station {
        background-color: #444;
        border-color: #555;
        color: #ffffff;
      }
      body.dark-mode .station h3 {
        color: #90CAF9;
      }
      body.dark-mode .station p {
        color: #cccccc;
      }
      body.dark-mode .modal {
        background-color: #333;
        color: #ffffff;
      }
      body.dark-mode .overlay {
        background-color: rgba(0, 0, 0, 0.8);
      }
      body.dark-mode #loading {
        background: #ffffff;
        color: #000000;
      }
      body.dark-mode #loadingOverlay {
        background-color: rgba(51, 51, 51, 0.9);
      }
      body.dark-mode #loadingText {
        color: #ffffff;
      }
      body.dark-mode #noticeBox {
        background-color: #000;
        color: #000;
        border: 1px solid #444;
      }
      #toggleDarkMode {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #007BFF, #0056b3);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: background 0.3s ease, transform 0.2s ease;
      }
      #toggleDarkMode:hover {
        background: linear-gradient(135deg, #0056b3, #003f7f);
        transform: scale(1.1);
      }
      body.dark-mode #toggleDarkMode {
        background: linear-gradient(135deg, #90caf9, #64b5f6);
        color: #121212;
      }
      body.dark-mode #toggleDarkMode:hover {
        background: linear-gradient(135deg, #64b5f6, #42a5f5);
      }
      /* 針對窄螢幕的調整 */
      @media (max-width: 768px) {
        .station {
          width: calc(50% - 20px);
        }
        #searchContainer {
            padding: 8px 12px;
        }
        #keyword {
          width: calc(100% - 24px - 10px - 24px - 10px);
          margin-right: 0;
          margin-bottom: 0;
          border-radius: 28px;
          display: block;
          padding: 0 5px;
        }
         #searchIcon {
             margin-right: 8px;
             font-size: 24px;
             width: 24px;
             height: 24px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }
         #locationIcon {
            margin-left: 8px;
            font-size: 24px;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
         }

        button {
          padding: 10px 20px;
          border-radius: 5px;
          width: auto; /* 調整寬度 */
          display: block;
        }


        #results {
          gap: 10px;
        }
        .station {
          margin-bottom: 10px;
        }
      }
      @media (max-width: 480px) {
        .station {
          width: 100%;
        }
        #searchContainer {
             padding: 10px;
         }
         #keyword {
             width: calc(100% - 24px - 8px - 24px - 8px);
             padding: 0 5px;
         }
          #searchIcon {
             margin-right: 5px;
         }
          #locationIcon {
             margin-left: 5px;
         }
         button {
            padding: 8px 16px;
         }
      }
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.5s ease;
      }
      #loadingContent {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      #loadingText {
        font-size: 1.5em;
        color: #007BFF;
        text-align: center;
      }

      #githubButton img {
        display: block;
        margin: 0;
        width: 45px;
        height: 45px;
        object-fit: contain;
      }

      #extraButtons {
          position: fixed;
          bottom: 120px;
          right: 80px;
          transform: translateX(100%);
          transition: transform 0.5s ease;
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1000;
      }
      #extraButtons.show {
          transform: translateX(0);
      }
      #extraButtons a {
          width: 50px;
          height: 50px;
          background-color: white;
          color: black;
          border: none;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
          text-decoration: none;
          transition: background-color 0.3s ease;
      }
      #extraButtons a:hover {
          background-color: #f0f0f0;
      }
      @keyframes popUp {
          0% { transform: translateX(100%) scale(0.5); opacity: 0; }
          100% { transform: translateX(0) scale(1); opacity: 1; }
      }
      @keyframes popDown {
          0% { transform: translateX(0) scale(1); opacity: 1; }
          100% { transform: translateX(100%) scale(0.5); opacity: 0; }
      }
      #extraButtons {
          position: fixed;
          bottom: 120px;
          right: 80px;
          transform: translateX(100%) scale(0.5);
          opacity: 0;
          transition: transform 0.5s ease, opacity 0.5s ease;
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1000;
      }
      #extraButtons.show {
          transform: translateX(0) scale(1);
          opacity: 1;
          animation: popUp 0.5s forwards;
      }
      #extraButtons.hiding {
          animation: popDown 0.5s forwards;
      }
      #extraButtons a:hover {
          background-color: #f0f0f0;
      }
      #extraButtons.hiding {
          animation: popDown 0.5s forwards;
      }
      #settingsPanel {
          position: fixed;
          bottom: 60px;
          right: 80px; /* 調整至適合位置 */
          display: flex;
          flex-direction: row;
          gap: 10px;
          z-index: 1000;
          transform: translateX(100%) scale(0.5);
          opacity: 0;
          transition: transform 0.5s ease, opacity 0.5s ease;
      }
      #settingsPanel.show {
          transform: translateX(0) scale(1);
          opacity: 1;
          animation: popUpSettings 0.5s forwards;
      }
      #darkModeToggle {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 50px;
          height: 50px;
          background: linear-gradient(135deg, #007BFF, #0056b3);
          border: none;
          color: white;
          border-radius: 50%;
          cursor: pointer;
          font-size: 24px;
          transition: background 0.3s ease, transform 0.2s ease;
      }
      #darkModeToggle:hover, #langToggle:hover {
          background-color: #f0f0f0;
          transform: scale(1.1);
      }
      /* 新增針對 settingsPanel 的動畫 */
      @keyframes popUpSettings {
          0% { transform: translateX(150%) scale(0.5); opacity: 0; }
          100% { transform: translateX(0) scale(1); opacity: 1; }
      }
      /* 新增 settingsPanel 收合動畫 */
      @keyframes popDownSettings {
          0% { transform: translateX(0) scale(1); opacity: 1; }
          100% { transform: translateX(150%) scale(0.5); opacity: 0; }
      }

      #settingsPanel.hiding {
          animation: popDownSettings 0.5s forwards;
      }
      #updateCountdown {
          white-space: nowrap;
      }

    </style>
  </head>
  <body>
    <div id="loadingOverlay">
      <div id="loadingContent">
        <h2 id="loadingText">載入中</h2>
        <div id="noticeBox" style="margin-top: 10px; margin-left: 20px; margin-right: 20px; background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></div>
      </div>
    </div>
    <div id="mainContent" style="display:none;">
      <h1 id="heading"></h1>
      <div id="searchContainer">
        <span id="searchIcon" class="material-icons" title="搜尋">search</span>
        <input type="text" id="keyword" placeholder="請輸入站點名稱、地址" value="" />
        <span id="locationIcon" class="material-icons" title="使用定位">my_location</span>
      </div>
      <input type="checkbox" id="toggleUseLocation" style="display: none;">

      <div id="results"></div>
      <div id="loading">載入中，請稍候...</div>
      <div class="overlay"></div>
      <div class="modal" id="permissionModal">
        <p id="modalText"></p>
        <button id="modalButton">確定</button>
      </div>
      <div id="extraButtons">
          <a href="https://github.com/potatosserver/YouBike" target="_blank">
              <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/html.webp" alt="YouBike Repo" style="width:30px; height:30px;" />
          </a>
          <a href="https://github.com/potatosserver/YouBike_Python" target="_blank">
                <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/python.webp" alt="YouBike Python" style="width:30px; height:30px;" />
          </a>
      </div>
      </div>
      <a id="githubLink" title="GitHub Repository" href="https://github.com/KEVIN970712/YouBike" target="_blank">
        <button id="githubButton" style="position: fixed; bottom: 120px; right: 20px; z-index: 1000; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/github.webp" alt="GitHub" style="width:35px; height:35px;" />
        </button>
      </a>
      <button id="settingsButton" title="設定" style="position: fixed; bottom: 60px; right: 20px; z-index: 1200; width: 50px; height: 50px; background: white; color: black; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; transition: transform 0.2s ease;">⚙️</button>
      <div id="settingsPanel">
        <button id="darkModeToggle" title="切換暗色模式">🌙</button>
        <button id="langToggle" title="Switch Language" style="width:50px; height:50px; border-radius:50%; margin-left:5px; display:flex; align-items:center; justify-content:center;">
          <img loading="lazy" src="https://potatosserver.github.io/YouBike/icons/translate.webp" alt="Translate" style="width:35px; height:35px;" />
        </button>
      </div>
    </div>
    <button id="updateCountdown" style="display:none; position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 6px 12px; background-color: white; color: #007bff; border: 2px solid #007bff; border-radius: 25px; font-size: 0.8em; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: all 0.3s ease; width: 100px;">60秒後更新</button>
    <script>
      let userLocation = null;
      let sortingLocked = false;
      let initialLoad = true;
      let locationDenied = false;
      let geolocationErrorMessage = null;
      let dataLoaded = false;
      const defaultLatitude = 22.6315725;
      const defaultLongitude = 120.3025079;
      const overlay = document.querySelector('.overlay');
      const modal = document.querySelector('.modal');
      const modalText = document.getElementById('modalText');
      const modalButton = document.getElementById('modalButton');
      const resultsDiv = document.getElementById('results');
      const loadingDiv = document.getElementById('loading');
      const keywordInput = document.getElementById('keyword');
      const maxResults = 100;
      const defaultSearchArea = "";
      const pinnedStations = new Set(JSON.parse(localStorage.getItem('pinnedStations') || '[]').map(id => String(id)));

      // 獲取定位圖示和隱藏的 checkbox
      const locationIcon = document.getElementById('locationIcon');
      const toggleUseLocationCheckbox = document.getElementById('toggleUseLocation'); // 獲取隱藏的 checkbox

      // 頁面載入時，根據 localStorage 中的設置初始化 checkbox 狀態並更新圖示
      document.addEventListener('DOMContentLoaded', () => {
        const useLocationSetting = localStorage.getItem("useLocation");
        // 預設使用定位，如果 localStorage 沒有設置或設置為 "true"
        const useLocation = useLocationSetting === null ? true : useLocationSetting === "true";
        toggleUseLocationCheckbox.checked = useLocation;

        // 根據 checkbox 的初始狀態設置圖示樣式
        if (toggleUseLocationCheckbox.checked) {
          locationIcon.classList.add('active');
          // 您可以選擇更換圖示，例如顯示為填充的定位圖示
          // locationIcon.textContent = 'location_on';
        } else {
          locationIcon.classList.remove('active');
          // 還原為非填充的定位圖示
          // locationIcon.textContent = 'my_location';
        }

        // 頁面載入後，如果定位是開啟的，則獲取定位；否則使用預設座標搜尋
        if (toggleUseLocationCheckbox.checked) {
            getLocation(); // 獲取定位
        } else {
            userLocation = { latitude: defaultLatitude, longitude: defaultLongitude };
            searchYouBike(); // 使用預設座標搜尋
        }
        // 其他現有的 DOMContentLoaded 邏輯...
      });


      // 修改為處理定位圖示的點擊事件
      locationIcon.addEventListener('click', function () {
        // 切換 checkbox 的 checked 狀態
        toggleUseLocationCheckbox.checked = !toggleUseLocationCheckbox.checked;

        // 根據 checkbox 的新狀態更新圖示樣式和執行相應邏輯
        if (toggleUseLocationCheckbox.checked) {
          // 定位功能開啟
          locationIcon.classList.add('active');
          // 如果您想切換圖示，可以在這裡設置 textContent
          // locationIcon.textContent = 'location_on';
          localStorage.setItem("useLocation", "true");
          sortingLocked = true; // 獲取定位後鎖定排序，直到定位成功
          getLocation(); // 觸發獲取定位
        } else {
          // 定位功能關閉
          locationIcon.classList.remove('active');
          // 如果您想切換圖示，可以在這裡設置 textContent
          // locationIcon.textContent = 'my_location';
          localStorage.setItem("useLocation", "false");
          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude }; // 切換到使用預設座標
          searchYouBike(); // 使用預設座標重新搜尋
          updateVehicleData(); // 更新車輛數據（離線時不執行）
          setTimeout(updateResultsOrder, 1500); // 重新排序結果
        }
      });

      function togglePinStation(stationId, event) {
        event.stopPropagation();

        // 統一轉換為字串類型
        const id = String(stationId);

        // 更新 pinnedStations Set
        if (pinnedStations.has(id)) {
          pinnedStations.delete(id);
        } else {
          pinnedStations.add(id);
        }

        // 立即更新 localStorage
        try {
          localStorage.setItem('pinnedStations', JSON.stringify([...pinnedStations]));
        } catch (e) {
          console.error('Failed to save pinned stations:', e);
        }

        // 更新按鈕狀態
        const pinButton = document.querySelector(`.pin-button[data-id="${id}"]`);
        if (pinButton) {
          const isPinned = pinnedStations.has(id);
          pinButton.classList.toggle('pinned', isPinned);
          pinButton.textContent = isPinned ? '★' : '☆';
        }

        // 重新排序結果
        updateResultsOrder();
      }
      let mainContentShown = false;
      function showMainContent() {
        if (!mainContentShown) {
          const overlay = document.getElementById("loadingOverlay");
          const mainContent = document.getElementById("mainContent");
          if (navigator.onLine) {
            overlay.style.opacity = "0";
            setTimeout(() => {
              overlay.style.display = "none";
              mainContent.style.display = "block";
              document.getElementById('updateCountdown').style.display = "block";
            }, 500);
          } else {
            const lang = localStorage.getItem("lang") || "zh";
            document.getElementById("loadingText").textContent = lang === "en" ? "Offline mode starting..." : "離線模式啟動中...";
            overlay.style.opacity = "1";
            setTimeout(() => {
              overlay.style.display = "none";
              mainContent.style.display = "block";
              document.getElementById('updateCountdown').style.display = "block";
            }, 3000);
          }
          mainContentShown = true;
        }
      }
      (function simulateLoadingPercentage() {
        const loadingText = document.getElementById("loadingText");
        let lang = localStorage.getItem("lang") || "zh";
        let prefix = lang === "en" ? "Loading:" : "載入中：";
        let progress = 0;
        let lockedProgress = null;
        loadingTextInterval = setInterval(() => {
          if (!mainContentShown) {
            if (progress < 85) {
              progress++;
              loadingText.textContent = prefix + progress + "%";
            } else {
              if (lockedProgress === null) {
                lockedProgress = 85 + Math.floor(Math.random() * 11);
              }
              loadingText.textContent = prefix + lockedProgress + "%";
            }
          } else {
            clearInterval(loadingTextInterval);
          }
        }, 50);
      })();
      (function showRandomNotice(){
        let lang = localStorage.getItem("lang") || "zh";
        const notices = lang === "en" ? [
              "❌Do not speed or ride in reverse",
              "❌Do not change lanes arbitrarily on sidewalks",
              "❌Do not use your phone while riding",
              "❌Avoid harsh braking while riding",
              "✔️Remember to adjust the seat to a proper height",
              "✔️Ensure that both front and rear lights are working",
              "✔️Remember to get bicycle accident insurance",
              "✔️Take your belongings from the basket"
        ] : [
              "❌勿超速或逆向騎乘",
              "❌勿隨意變換車道在行人道上騎乘",
              "❌勿在車輛行駛中使用手機",
              "❌騎乘中勿緊急煞車",
              "✔️記得調整座墊至適宜高度",
              "✔️確認前後車燈功能正常",
              "✔️記得投保公共自行車傷害險",
              "✔️記得帶走置物籃內的隨身物品"
        ];
        const randomIndex = Math.floor(Math.random() * notices.length);
        document.getElementById('noticeBox').textContent = notices[randomIndex];
      })();

      let youbikeDataCache = null;

      async function searchYouBike(showLoadingIndicator = true) {
        if (showLoadingIndicator) showLoading();
        const keyword = keywordInput.value.trim().toLowerCase();
        try {
          if (navigator.onLine) {
            if (!youbikeDataCache) {
              const youbikeUrl = "https://apis.youbike.com.tw/json/station-min-yb2.json";
              const response = await fetch(youbikeUrl, {
                headers : {
                  'accept': '*/*',
                  'accept-language': 'zh-TW,zh;q=0.9',
                }
              });
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              const youbikeData = await response.json();
              youbikeDataCache = Array.isArray(youbikeData)
                ? youbikeData.map(item => ({ ...item, lat: parseFloat(item.lat), lng: parseFloat(item.lng) }))
                : [];
              localStorage.setItem('cachedYoubikeData', JSON.stringify(youbikeDataCache));
            }
          } else {
            // 離線模式下嘗試從 localStorage 載入
            if (!youbikeDataCache) {
              youbikeDataCache = JSON.parse(localStorage.getItem('cachedYoubikeData') || '[]').map(item => ({
                ...item,
                lat: parseFloat(item.lat),
                lng: parseFloat(item.lng)
              }));
              // 如果離線且沒有快取數據，顯示錯誤訊息
              if (youbikeDataCache.length === 0) {
                const errorMessage = currentLang === "en" ? "Offline mode: No cached data available." : "離線模式：無快取資料可用。";
                resultsDiv.innerHTML = `<p style="text-align:center; color:#ff0000;">${errorMessage}</p>`;
                hideLoading();
                showMainContent(); // 即使沒有數據也顯示主內容
                return; // 停止執行後續邏輯
              }
            }
          }

          let youbikeResults = youbikeDataCache;
          if (keyword) {
            youbikeResults = youbikeResults.filter(station => {
              const stationNameTW = station.name_tw ? station.name_tw.toLowerCase() : '';
              const stationAddressTW = station.address_tw ? station.address_tw.toLowerCase() : '';
              const stationNameEN = station.name_en ? station.name_en.toLowerCase() : '';
              const stationAddressEN = station.address_en ? station.address_en.toLowerCase() : '';
              return stationNameTW.includes(keyword) || stationAddressTW.includes(keyword) ||
                     stationNameEN.includes(keyword) || stationAddressEN.includes(keyword);
            });
          }
          youbikeResults = youbikeResults.sort((a, b) => {
            const distA = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              a.lat, a.lng
            );
            const distB = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              b.lat, b.lng
            );
            return distA - distB;
          });
          let limit = keyword ? 50 : 20;
          let usedStations;
          if (!keyword) {
            const pinnedFromLocal = youbikeResults.filter(station => pinnedStations.has(String(station.station_no)));
            const unpinned = youbikeResults.filter(station => !pinnedStations.has(String(station.station_no)));
            pinnedFromLocal.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            unpinned.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedFromLocal, ...unpinned].slice(0, limit);
          } else {
            usedStations = youbikeResults.slice(0, limit);
            const pinnedList = usedStations.filter(station => pinnedStations.has(String(station.station_no)));
            const nonPinnedList = usedStations.filter(station => !pinnedStations.has(String(station.station_no)));
            pinnedList.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            nonPinnedList.sort((a, b) => {
              const distA = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                a.lat, a.lng
              );
              const distB = calculateDistance(
                userLocation ? userLocation.latitude : defaultLatitude,
                userLocation ? userLocation.longitude : defaultLongitude,
                b.lat, b.lng
              );
              return distA - distB;
            });
            usedStations = [...pinnedList, ...nonPinnedList];
          }
          const isOnline = navigator.onLine;
          let vehData = {};
          const stationIds = usedStations.map(station => String(station.station_no));
          if (isOnline) {
            // 在線模式下才查詢車輛數據
            vehData = await queryVehicleData(stationIds);
          }
          // 修改站點資訊依語言切換: 若為英文則取英文屬性
          const organizedOutput = usedStations.map(site => {
            const info = {
              id: String(site.station_no),
              name: currentLang === "en" ? site.name_en : site.name_tw,
              coords: [site.lat, site.lng],
              district: currentLang === "en" ? site.district_en : site.district_tw,
              address: currentLang === "en" ? site.address_en : site.address_tw
            };
            // 離線模式下 vehicle_info 應為空對象或預設值
            const vehicle = isOnline ? (Object.entries(vehData).find(([key]) => key === info.id)?.[1] || {}) : {};
            return { station_info: info, vehicle_info: vehicle };
          });

          // 清空現有結果，準備重新渲染
          resultsDiv.innerHTML = '';

          organizedOutput.forEach(item => {
            const station = item.station_info;
            const vehicle = item.vehicle_info;
            let card = document.querySelector(`.station[data-id="${station.id}"]`);

            // 確保釘選狀態判斷一致
            const isPinned = pinnedStations.has(String(station.id));
            const pinButtonHtml = `<span
              class="pin-button ${isPinned ? 'pinned' : ''}"
              data-id="${station.id}"
              onclick="togglePinStation('${station.id}', event)"
            >${isPinned ? '★' : '☆'}</span>`;
            const distance = calculateDistance(
              userLocation ? userLocation.latitude : defaultLatitude,
              userLocation ? userLocation.longitude : defaultLongitude,
              station.coords[0],
              station.coords[1]
            );
            const displayDistance = distance < 1 ? Math.round(distance * 1000) + (currentLang === "en" ? " m" : " 公尺")
                                                 : distance.toFixed(2) + (currentLang === "en" ? " km" : " 公里");
            const distanceLabel = currentLang === "en" ? "Distance:" : "距離:";
            const addressLabel = currentLang === "en" ? "Address:" : "地址:";
            const slotsLabel = currentLang === "en" ? "Available Slots:" : "可停空位數:";
            const unknownStation = currentLang === "en" ? "Unknown Station" : "未知站點";
            const unknownAddress = currentLang === "en" ? "Unknown Address" : "未知地址";
            const unknownValue = currentLang === "en" ? "Unknown" : "未知";

            // 離線模式下不顯示車輛資訊
            const vehicleInfoHtml = isOnline ? `
                          <p>YouBike 2.0: <span class="vehicle_yb2">${vehicle?.available_2_0 !== undefined ? vehicle.available_2_0 : unknownValue}</span></p>
                          <p>YouBike 2.0E: <span class="vehicle_e">${vehicle?.available_e !== undefined ? vehicle.available_e : unknownValue}</span></p>
                          <p>${slotsLabel} <span class="vehicle_empty">${vehicle?.empty_spaces !== undefined ? vehicle.empty_spaces : unknownValue}</span></p>
                        ` : '';

            // 當使用預設座標時不顯示距離
            const isDefaultLocation = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
            const distanceHTML = !isDefaultLocation ? `<p class="distance">${distanceLabel} ${displayDistance}</p>` : "";

            const cardContent = `
                          ${pinButtonHtml}
                          <h3>${station.name || unknownStation}</h3>
                          ${distanceHTML}
                          <p>${addressLabel} ${station.address || unknownAddress}</p>
                          ${vehicleInfoHtml}
                      `;
            // 創建新的卡片元素
            card = document.createElement('div');
            card.className = 'station';
            card.dataset.id = station.id;
            card.dataset.lat = station.coords[0];
            card.dataset.lng = station.coords[1];
            // 根據螢幕寬度調整卡片寬度
            card.style.width = window.innerWidth < 768 ? (window.innerWidth < 480 ? "100%" : "calc(50% - 10px)") : "calc(33% - 14px)";
            card.innerHTML = cardContent;

            resultsDiv.appendChild(card);
          });

          updateResultsOrder(); // 重新排序所有卡片
          await new Promise(resolve => setTimeout(resolve, 0));

          dataLoaded = true;
          if (showLoadingIndicator) {
            showMainContent();
          }
        } catch (error) {
          console.error("Fetch error:", error);
          // 顯示錯誤訊息給使用者
          resultsDiv.innerHTML = `<p style="text-align:center; color:#ff0000;">發生錯誤: ${error.message}</p>`;
        } finally {
          if (showLoadingIndicator) hideLoading();
        }
      }
      async function queryVehicleData(stationIds) {
        if (stationIds.length === 0 || !navigator.onLine) {
            return {}; // 如果沒有站點ID或離線，直接返回空對象
        }
        if (stationIds.length > 60) {
          stationIds = stationIds.slice(0, 60);
        }
        const batchSize = 20;
        const allVehicleData = {};
        const headers = {
          'Accept': '*/*',
          'Content-Type': 'application/json',
          'Origin': 'https://www.youbike.com.tw',
          'Referer': 'https://www.youbike.com.tw/'
        };
        for (let i = 0; i < stationIds.length; i += batchSize) {
          const stationIdBatch = stationIds.slice(i, i + batchSize);
          const body = JSON.stringify({ station_no: stationIdBatch });
          try {
            const response = await fetch('https://apis.youbike.com.tw/tw2/parkingInfo', {
              method: 'POST',
              headers,
              body
            });
            const result = await response.json();
            if (result.retCode === 1 && result.retVal && result.retVal.data) {
              const dataArray = result.retVal.data;
              dataArray.forEach(item => {
                allVehicleData[item.station_no] = {
                  available_2_0: item.available_spaces_detail ? item.available_spaces_detail.yb2 : 0,
                  available_e: item.available_spaces_detail ? item.available_spaces_detail.eyb : 0,
                  empty_spaces: item.empty_spaces || 0
                };
              });
            } else {
              console.error("API 請求失敗:", result.retMsg);
            }
          } catch (e) {
            console.error(e);
          }
        }
        return allVehicleData;
      }
      function updateResultsOrder() {
        const cards = Array.from(document.querySelectorAll(".station"));
        cards.sort((a, b) => {
          const aPinned = pinnedStations.has(a.dataset.id);
          const bPinned = pinnedStations.has(b.dataset.id);
          if (aPinned && !bPinned) return -1;
          if (!aPinned && bPinned) return 1;
          const distanceA = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(a.dataset.lat),
            parseFloat(a.dataset.lng)
          );
          const distanceB = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            parseFloat(b.dataset.lat),
            parseFloat(b.dataset.lng)
          );
          return distanceA - distanceB;
        });
        // 使用 document fragment 提高性能
        const fragment = document.createDocumentFragment();
        cards.forEach(card => {
          fragment.appendChild(card);
        });
        resultsDiv.appendChild(fragment);
      }
      function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadingOverlay').style.opacity = '1';
      }
      function hideLoading() {
         const overlay = document.getElementById('loadingOverlay');
        overlay.style.opacity = '0';
        setTimeout(() => {
            overlay.style.display = 'none';
        }, 500);
      }
      function showModal(message) {
        modalText.textContent = message;
        overlay.classList.add('show');
        modal.classList.add('show');
      }
      function hideModal() {
        overlay.classList.remove('show');
        modal.classList.remove('show');
      }
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // 處理成功獲取定位
      async function handleGeolocationSuccess(position) {
        const wasDefault = !userLocation || (userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude);
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        // 定位成功，確保圖示處於 active 狀態
        locationIcon.classList.add('active');
        // locationIcon.textContent = 'location_on';

        if (wasDefault) {
          // 首次獲取定位成功，重新搜尋並排序
          await searchYouBike();
          updateResultsOrder();
        } else {
          // 定時更新獲取定位成功，只更新距離顯示和排序
          updateCardDistances();
        }
      }

      // 處理定位錯誤
      function handleGeolocationError(error) {
        console.error("Geolocation error:", error);
        locationDenied = true; // 標記定位被拒絕或出錯
        let errorMessage = "";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = currentLang === "en"
              ? "Location permission was denied; using default coordinates."
              : "未提供定位權限，將使用預設座標進行定位。";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = currentLang === "en"
              ? "Location information is unavailable; using default coordinates until the location is determined."
              : "定位資訊不可用，將使用預設座標進行定位直到定位成功。";
            break;
          case error.TIMEOUT:
            errorMessage = currentLang === "en"
              ? "The location request timed out; using default coordinates until a successful location is acquired."
              : "定位逾時，將使用預設座標進行定位直到定位成功。";
            break;
          default:
            errorMessage = currentLang === "en"
              ? "A location error occurred; using default coordinates until a valid location is determined."
              : "定位錯誤，將使用預設座標進行定位直到定位成功。";
            break;
        }
        showModal(errorMessage);

        // 定位失敗，強制關閉定位開關和圖示，並切換到預設座標搜尋
        toggleUseLocationCheckbox.checked = false;
        localStorage.setItem("useLocation", "false");
        locationIcon.classList.remove('active');
        // locationIcon.textContent = 'my_location';

        userLocation = { latitude: defaultLatitude, longitude: defaultLongitude }; // 切換到預設座標
        searchYouBike(); // 使用預設座標重新搜尋
        // hideLoading(); // 載入邏輯可能需要調整
      }

      // 處理定時定位更新成功
      function handleGeoUpdateSuccess(position) {
        const wasDefault = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };

        // 定位更新成功，確保圖示處於 active 狀態
         locationIcon.classList.add('active');
        // locationIcon.textContent = 'location_on';

        if (wasDefault) {
          // 如果之前是預設座標（例如首次定位失敗後），現在定位成功，重新搜尋並排序
          searchYouBike().then(() => {
            updateResultsOrder();
          });
        } else {
          // 如果之前已經有定位，只是更新，則只更新距離顯示和排序
          updateCardDistances();
        }
      }

      // 處理定時定位更新錯誤
      function handleGeoUpdateError(error) {
        console.error("Geolocation update error:", error);
        // 定位更新失敗時，如果開關是開的，可以考慮顯示一個小提示或保持原樣
        // 不應該直接關閉定位，除非是持續性的嚴重錯誤，這部分邏輯目前保留原樣
      }

      // 獲取定位的函數
      function getLocation() {
        // 只有當定位功能開啟時才嘗試獲取定位
        if (!toggleUseLocationCheckbox.checked) {
             // 如果定位開關是關閉的，直接返回，不執行定位邏輯
             userLocation = { latitude: defaultLatitude, longitude: defaultLongitude }; // 確保 userLocation 是預設座標
             searchYouBike(); // 使用預設座標搜尋
             return;
        }

        if (navigator.geolocation) {
          let timeoutTriggered = false;
          const geoTimeout = setTimeout(() => {
            timeoutTriggered = true;
            // 如果超時，觸發定位錯誤處理
            handleGeolocationError({ code: 3, message: "首次定位超時" });
          }, 10000); // 最大等待10秒

          // 嘗試獲取當前位置
          navigator.geolocation.getCurrentPosition(
            function (position) {
              if (!timeoutTriggered) {
                clearTimeout(geoTimeout);
                handleGeolocationSuccess(position); // 處理成功
              }
            },
            function (error) {
              if (!timeoutTriggered) {
                clearTimeout(geoTimeout);
                handleGeolocationError(error); // 處理錯誤
              }
            },
            {
              enableHighAccuracy: true,
              timeout: 10000, // 最大等待10秒
              maximumAge: 0
            }
          );

          // 設置定時更新定位（只有當首次獲取成功或後續成功時才需要）
          // 這部分的 setInterval 需要在 handleGeolocationSuccess 或 handleGeoUpdateSuccess 中啟動更合適
          // 避免在定位被拒絕或出錯時仍然嘗試定時更新
          // 為了簡化，目前保留在這裡，但在定位錯誤時會強制關閉 toggleUseLocationCheckbox
          // 這使得定時器在下次檢查時不會執行定位請求
          setInterval(() => {
            if (toggleUseLocationCheckbox.checked) { // 只有當開關開啟時才進行定時更新
              navigator.geolocation.getCurrentPosition(
                handleGeoUpdateSuccess,
                handleGeoUpdateError,
                {
                  enableHighAccuracy: true,
                  timeout: 10000,
                  maximumAge: 0
                }
              );
            }
          }, 10000); // 每10秒更新一次
        } else {
          // 瀏覽器不支援地理位置
          showModal("您的瀏覽器不支援地理位置功能。站點將以將使用預設座標進行定位。");
          // 強制關閉定位開關和圖示
          toggleUseLocationCheckbox.checked = false;
          localStorage.setItem("useLocation", "false");
          locationIcon.classList.remove('active');
          // locationIcon.textContent = 'my_location';

          userLocation = { latitude: defaultLatitude, longitude: defaultLongitude }; // 切換到預設座標
          searchYouBike(); // 使用預設座標搜尋
          hideLoading(); // 隱藏加載提示
        }
      }

      // 更新站點卡片距離顯示
      function updateCardDistances() {
        const cards = document.querySelectorAll('.station');
        cards.forEach(card => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          const newDistance = calculateDistance(
            userLocation ? userLocation.latitude : defaultLatitude,
            userLocation ? userLocation.longitude : defaultLongitude,
            lat, lng
          );
          let distanceEl = card.querySelector('.distance');

          // 當使用預設座標時，隱藏距離顯示
          const isDefaultLocation = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;

          if (isDefaultLocation) {
              if (distanceEl) {
                  distanceEl.remove(); // 如果存在距離元素，則移除它
              }
          } else {
              const distanceLabel = currentLang === "en" ? "Distance:" : "距離:";
              const unit = newDistance < 1 ? (currentLang === "en" ? " m" : " 公尺") : (currentLang === "en" ? " km" : " 公里");
              const displayDistance = newDistance < 1 ? Math.round(newDistance * 1000) : newDistance.toFixed(2);

              if (!distanceEl) {
                  // 如果距離元素不存在，創建一個並插入到標題下方、地址上方
                  distanceEl = document.createElement('p');
                  distanceEl.classList.add('distance');
                  const addressEl = card.querySelector('p'); // 找到地址元素
                  if (addressEl) {
                      card.insertBefore(distanceEl, addressEl);
                  } else {
                       card.appendChild(distanceEl); // 如果沒有地址元素，就加到卡片末尾 (作為後備)
                  }
              }
              distanceEl.textContent = distanceLabel + " " + displayDistance + unit;
          }
        });
        updateResultsOrder(); // 距離更新後重新排序
      }


      // 更新車輛數據
      function updateVehicleData() {
        const stationElements = document.querySelectorAll('.station');
        if (!stationElements.length || !navigator.onLine) {
             // 離線時或沒有站點元素時不更新車輛數據
             // 在離線模式下，清除車輛信息，或者顯示離線提示
             stationElements.forEach(card => {
                 const yb2El = card.querySelector('.vehicle_yb2');
                 const ybeEl = card.querySelector('.vehicle_e');
                 const emptyEl = card.querySelector('.vehicle_empty');
                 const unknownValue = currentLang === "en" ? "Unknown" : "未知";
                 if (yb2El) yb2El.textContent = unknownValue;
                 if (ybeEl) ybeEl.textContent = unknownValue;
                 if (emptyEl) emptyEl.textContent = unknownValue;

                 // 如果是離線模式，確保顯示車輛信息的 p 標籤仍然存在，只是內容是未知或提示離線
                 // 否則下次在線時這些 p 標籤可能需要重新創建
             });
             return;
        }

        const stationIds = Array.from(stationElements).map(el => el.dataset.id);
        queryVehicleData(stationIds)
          .then(vehicleData => {
            stationElements.forEach(card => {
              const id = card.dataset.id;
              const data = vehicleData[id] || {};
              const yb2El = card.querySelector('.vehicle_yb2');
              const ybeEl = card.querySelector('.vehicle_e');
              const emptyEl = card.querySelector('.vehicle_empty');
              const unknownValue = currentLang === "en" ? "Unknown" : "未知";

              // 確保這些元素存在，如果不存在則創建
              let yb2P = card.querySelector('p .vehicle_yb2')?.parentElement;
              if (!yb2P) {
                  yb2P = document.createElement('p');
                   card.appendChild(yb2P); // 添加到卡片末尾
                   yb2P.innerHTML = `YouBike 2.0: <span class="vehicle_yb2">${unknownValue}</span>`;
              }
               let ybeP = card.querySelector('p .vehicle_e')?.parentElement;
              if (!ybeP) {
                   ybeP = document.createElement('p');
                   card.appendChild(ybeP);
                   ybeP.innerHTML = `YouBike 2.0E: <span class="vehicle_e">${unknownValue}</span>`;
              }
              let emptyP = card.querySelector('p .vehicle_empty')?.parentElement;
               if (!emptyP) {
                   emptyP = document.createElement('p');
                   card.appendChild(emptyP);
                    const slotsLabel = currentLang === "en" ? "Available Slots:" : "可停空位數:";
                    emptyP.innerHTML = `${slotsLabel} <span class="vehicle_empty">${unknownValue}</span>`;
               }


              if (yb2El) yb2El.textContent = (data.available_2_0 !== undefined ? data.available_2_0 : unknownValue);
              if (ybeEl) ybeEl.textContent = (data.available_e !== undefined ? data.available_e : unknownValue);
              if (emptyEl) emptyEl.textContent = (data.empty_spaces !== undefined ? data.empty_spaces : unknownValue);
            });
            // updateResultsOrder(); // 更新車輛數據不影響排序，無需重新排序
          })
          .catch(error => {
            console.error("Vehicle data update failed:", error);
            // 車輛數據更新失敗時，顯示未知或錯誤提示
            stationElements.forEach(card => {
                 const yb2El = card.querySelector('.vehicle_yb2');
                 const ybeEl = card.querySelector('.vehicle_e');
                 const emptyEl = card.querySelector('.vehicle_empty');
                 const errorValue = currentLang === "en" ? "Error" : "錯誤";
                 if (yb2El) yb2El.textContent = errorValue;
                 if (ybeEl) ybeEl.textContent = errorValue;
                 if (emptyEl) emptyEl.textContent = errorValue;
            });
          });
      }


      const darkModeToggle = document.getElementById('darkModeToggle');
      darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("dark_mode", isDark);
        darkModeToggle.innerHTML = isDark ? '<span style="color:#ffd700; font-size:32px;">☀️</span>' : '🌙';
      });
      if (localStorage.getItem("dark_mode") === "true") {
        document.body.classList.add("dark-mode");
        darkModeToggle.innerHTML = '<span style="color:#ffd700; font-size:32px;">☀️</span>';
      }

      // 設定目前語言，預設為中文
      let currentLang = localStorage.getItem("lang") || "zh";

      // 更新頁面上所有與語言相關的文字
      function updateLanguageTexts() {
        document.title = currentLang === "en" ? "YouBike Site Search : A simple, beautiful site search engine" : "YouBike 站點搜尋 : 一個簡單、美觀、低流量的YouBike站點搜尋器";
        const heading = document.getElementById('heading');
        if (heading) {
            heading.textContent = currentLang === "en" ? "YouBike Station Search" : "YouBike 站點搜尋";
        }
        const keywordInput = document.getElementById('keyword');
        if (keywordInput) {
          keywordInput.placeholder = currentLang === "en" ? "Please enter station name or address" : "請輸入站點名稱、地址";
        }
        const updateCountdownBtn = document.getElementById('updateCountdown');
        if (updateCountdownBtn) {
          updateCountdownBtn.textContent = currentLang === "en" ? `${countdownTimer.remaining} sec update ` : `${countdownTimer.remaining}秒後更新`;
        }
        const loadingDiv = document.getElementById('loading');
        if (loadingDiv) {
          loadingDiv.textContent = currentLang === "en" ? "Loading, please wait..." : "載入中，請稍候...";
        }
         // 更新 noticeBox 的文字
        const noticeBox = document.getElementById('noticeBox');
        if (noticeBox) {
             const notices = currentLang === "en" ? [
                  "❌Do not speed or ride in reverse",
                  "❌Do not change lanes arbitrarily on sidewalks",
                  "❌Do not use your phone while riding",
                  "❌Avoid harsh braking while riding",
                  "✔️Remember to adjust the seat to a proper height",
                  "✔️Ensure that both front and rear lights are working",
                  "✔️Remember to get bicycle accident insurance",
                  "✔️Take your belongings from the basket"
            ] : [
                  "❌勿超速或逆向騎乘",
                  "❌勿隨意變換車道在行人道上騎乘",
                  "❌勿在車輛行駛中使用手機",
                  "❌騎乘中勿緊急煞車",
                  "✔️記得調整座墊至適宜高度",
                  "✔️確認前後車燈功能正常",
                  "✔️記得投保公共自行車傷害險",
                  "✔️記得帶走置物籃內的隨身物品"
            ];
             // 簡單處理：切換語言時，直接隨機顯示一個新的通知
            const randomIndex = Math.floor(Math.random() * notices.length);
            noticeBox.textContent = notices[randomIndex];
        }

        // 更新站點卡片中的語言相關文字和距離
        const stationCards = document.querySelectorAll('.station');
        stationCards.forEach(card => {
            const stationId = card.dataset.id;
            // 找到原始 youbikeDataCache 中的站點數據
            const originalStationData = youbikeDataCache ? youbikeDataCache.find(station => String(station.station_no) === stationId) : null;

            if (originalStationData) {
                const stationNameEl = card.querySelector('h3');
                const addressEl = card.querySelector('p:not(.distance)'); // 找到非距離的 p 標籤，假設是地址
                const distanceEl = card.querySelector('.distance'); // 距離標籤

                if (stationNameEl) {
                    stationNameEl.textContent = currentLang === "en" ? originalStationData.name_en : originalStationData.name_tw;
                }
                if (addressEl) {
                    const addressLabel = currentLang === "en" ? "Address:" : "地址:";
                     addressEl.textContent = `${addressLabel} ${currentLang === "en" ? originalStationData.address_en : originalStationData.address_tw}`;
                }

                 // 更新距離顯示（重新計算並設置文字）
                 if (distanceEl) {
                    const lat = parseFloat(card.dataset.lat);
                    const lng = parseFloat(card.dataset.lng);
                    const distance = calculateDistance(
                      userLocation ? userLocation.latitude : defaultLatitude,
                      userLocation ? userLocation.longitude : defaultLongitude,
                      lat, lng
                    );
                    const distanceLabel = currentLang === "en" ? "Distance:" : "距離:";
                    const unit = distance < 1 ? (currentLang === "en" ? " m" : " 公尺") : (currentLang === "en" ? " km" : " 公里");
                    const displayDistance = distance < 1 ? Math.round(distance * 1000) : distance.toFixed(2);

                    const isDefaultLocation = userLocation && userLocation.latitude === defaultLatitude && userLocation.longitude === defaultLongitude;
                     if (!isDefaultLocation) {
                       distanceEl.textContent = distanceLabel + " " + displayDistance + unit;
                       distanceEl.style.display = ''; // 確保距離顯示出來
                     } else {
                       distanceEl.style.display = 'none'; // 隱藏距離
                       distanceEl.textContent = ""; // 清空文字內容
                     }
                }


                // 更新車輛資訊標籤 (如果顯示的話)
                if (navigator.onLine) {
                    const slotsLabelSpan = card.querySelector('.vehicle_empty')?.parentElement; // 找到包含 empty_spaces 的 p 標籤
                    if (slotsLabelSpan) {
                         const slotsLabel = currentLang === "en" ? "Available Slots:" : "可停空位數:";
                         // 保留原有的數值，只更新標籤
                         const valueSpan = slotsLabelSpan.querySelector('.vehicle_empty');
                         if(valueSpan) {
                              const value = valueSpan.textContent.trim();
                              slotsLabelSpan.innerHTML = `${slotsLabel} <span class="vehicle_empty">${value}</span>`;
                         }
                    }
                } else {
                    // 離線模式下，更新車輛資訊為未知
                    const yb2El = card.querySelector('.vehicle_yb2');
                    const ybeEl = card.querySelector('.vehicle_e');
                    const emptyEl = card.querySelector('.vehicle_empty');
                    const unknownValue = currentLang === "en" ? "Unknown" : "未知";
                     if (yb2El) yb2El.textContent = unknownValue;
                     if (ybeEl) ybeEl.textContent = unknownValue;
                     if (emptyEl) emptyEl.textContent = unknownValue;
                }
            }
        });

         // 更新 modal 的文字
         const modalTextElement = document.getElementById('modalText');
         if (modalTextElement && geolocationErrorMessage) {
             // 這裡需要根據 geolocationErrorMessage 原始是哪種錯誤，然後根據 currentLang 設置對應的文字
             // 一種方法是在 handleGeolocationError 中存儲一個包含多語言的錯誤對象
             // 例如: { code: ..., messages: { en: "...", zh: "..." }}
             // 然後在這裡根據 currentLang 設置 modalTextElement.textContent = geolocationErrorMessage.messages[currentLang];
             // 為了簡化，假設 geolocationErrorMessage 已經是正確語言的訊息
             // 如果 modal 正在顯示，重新設置文字以更新顯示
             if (modal.classList.contains('show')) {
                 // 在 handleGeolocationError 中已經根據語言設置了 geolocationErrorMessage
                 // 所以這裡只需要重新賦值即可
                  modalTextElement.textContent = geolocationErrorMessage;
             }
         }
      }
      updateLanguageTexts();

      // 語言切換按鈕事件
      const langToggle = document.getElementById('langToggle');
      langToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        currentLang = currentLang === "en" ? "zh" : "en";
        localStorage.setItem("lang", currentLang);
        updateLanguageTexts(); // 更新所有靜態文字和卡片內的文字
        // 重新載入數據（如果需要的話，但更新卡片文字應該足夠）
        // searchYouBike(false); // 避免重新顯示 loading
      });

      const settingsButton = document.getElementById('settingsButton');
      const settingsPanel = document.getElementById('settingsPanel');
      const extraButtons = document.getElementById('extraButtons');
      const githubButton = document.getElementById('githubButton');

      settingsButton.addEventListener('click', (event) => {
        event.stopPropagation();
        // 隱藏 extraButtons
        if (extraButtons.classList.contains('show')) {
            extraButtons.classList.add('hiding');
            setTimeout(() => {
                extraButtons.classList.remove('show', 'hiding');
            }, 500);
        }
        // 切換 settingsPanel 顯示狀態
        if (settingsPanel.classList.contains('show')) {
          settingsPanel.classList.add('hiding');
          setTimeout(() => {
            settingsPanel.classList.remove('show', 'hiding');
          }, 500);
        } else {
          settingsPanel.classList.add('show');
        }
      });

       githubButton.addEventListener('click', (event) => {
           event.preventDefault(); // 防止默認的連結跳轉
           event.stopPropagation();
           // 隱藏 settingsPanel
           if (settingsPanel.classList.contains('show')) {
                settingsPanel.classList.add('hiding');
                setTimeout(() => {
                   settingsPanel.classList.remove('show', 'hiding');
               }, 500);
           }
            // 切換 extraButtons 顯示狀態
           if (extraButtons.classList.contains('show')) {
               extraButtons.classList.add('hiding');
               setTimeout(() => {
                   extraButtons.classList.remove('show', 'hiding');
               }, 500);
           } else {
               extraButtons.classList.add('show');
           }
       });

      // 點擊頁面其他地方時隱藏面板
      document.addEventListener('click', () => {
        if (settingsPanel.classList.contains('show')) {
          settingsPanel.classList.add('hiding');
          setTimeout(() => {
            settingsPanel.classList.remove('show', 'hiding');
          }, 500);
        }
         if(extraButtons.classList.contains('show')){
            extraButtons.classList.add('hiding');
             setTimeout(() => {
                extraButtons.classList.remove('show', 'hiding');
            }, 500);
        }
      });

      // 阻止點擊面板時觸發 document 的點擊事件
      settingsPanel.addEventListener('click', (event) => {
        event.stopPropagation();
      });
      extraButtons.addEventListener('click', (event) => {
           event.stopPropagation();
      });


      modalButton.addEventListener('click', hideModal);


      // 頁面載入時的初始化邏輯已移至 DOMContentLoaded 事件監聽器中


      keywordInput.addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
          searchYouBike();
        }
      });


      const searchIcon = document.getElementById('searchIcon');
      searchIcon.addEventListener('click', searchYouBike);

      let countdownTimer = {
          remaining: 60,
          updateButton: document.getElementById('updateCountdown'),
          updateDisplay: function() {
              this.updateButton.textContent = currentLang === "en"
                  ? `${this.remaining} sec update `
                  : `${this.remaining}秒後更新`;
          },
          reset: function() {
              this.remaining = 60;
          }
      };
      countdownTimer.updateDisplay();
      setInterval(() => {
          countdownTimer.remaining--;
          if (countdownTimer.remaining <= 0) {
              // 在定時更新時，如果定位開關是開啟的，則使用定位；否則使用預設座標
              if (toggleUseLocationCheckbox.checked) {
                  getLocation(); // 觸發定位更新
              } else {
                   userLocation = { latitude: defaultLatitude, longitude: defaultLongitude }; // 確保使用預設座標
                   searchYouBike(); // 使用預設座標重新搜尋
              }
              updateVehicleData(); // 定時更新車輛數據
              countdownTimer.reset();
          }
          countdownTimer.updateDisplay();
      }, 1000);
      countdownTimer.updateButton.addEventListener('click', () => {
          // 手動觸發更新時，如果定位開關是開啟的，則使用定位；否則使用預設座標
           if (toggleUseLocationCheckbox.checked) {
              getLocation(); // 觸發定位更新
          } else {
               userLocation = { latitude: defaultLatitude, longitude: defaultLongitude }; // 確保使用預設座標
               searchYouBike(); // 使用預設座標重新搜尋
          }
          updateVehicleData(); // 手動更新車輛數據
          countdownTimer.reset();
          countdownTimer.updateDisplay();
      });

    </script>
    <script defer>
      // Register Service Worker non-blocking
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
          navigator.serviceWorker
            .register("../YouBike/service-worker.js")
            .then(function (registration) {
              console.log('Service Worker registered with scope:', registration.scope);
            })
            .catch(function (error) {
              console.error('Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
